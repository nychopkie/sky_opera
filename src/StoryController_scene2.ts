import { Boid } from './Boid';
import { BoidSystem } from './BoidSystem';
import { Vector3, Color } from 'three';

// 可复用的故事配置接口
export interface StoryConfig {
    totalBoidCount: number;
    initialBoidCount: number;
    // 定义最终分成的组及其比例和颜色
    // groups: { ratio: number; color: Color }[];
    // 场景参数
    scene1_duration: number;
    scene2_duration: number;
    scene3_duration: number;
    scene4_duration: number;
}

type StoryScene = 'inactive' | 'scene1_linesPulse' | 'scene2_5g' | 'scene3_chips' | 'scene4_whirlpoolSwarm';

/**
 * 这是一个用于控制无人机群表演特定故事的控制器。
 * 它的设计是可复用的，只需提供不同的 `StoryConfig` 即可实现不同的故事。
 *
 * 实现原理：
 * 1. 状态机：内部通过一个简单的状态机 (`currentScene`) 来管理故事的三个阶段。
 * 2. 时间驱动：每个场景都有一个持续时间 (`sceneTime`)，当时间到达后会自动切换到下一个场景。
 * 3. 目标驱动：在每个场景中，控制器会为每个无人机计算一个特定的 `storyTarget`（目标位置）。
 *    - Boid 类本身的行为被修改为：当 `storyTarget` 存在时，它会产生一个强烈的、朝向该目标的力。
 *      这使得我们可以精确地控制无人机形成各种队形（螺旋、花朵、分组等），同时保留一些基础的群体行为。
 * 4. 视觉控制：控制器会直接修改 Boid 的 `isVisible` 和 `lightIntensity` 属性，
 *    这些属性随后被 `Scene.ts` 中的渲染器用来控制无人机的显示效果（是否可见、灯光亮度）。
 * 5. 配置化：所有的关键参数（如无人机数量、半径、高度、颜色等）都被提取到 `StoryConfig` 中，
 *    使得用户可以轻松地调整这些参数来复用此故事模板，讲述一个不同的、但结构相似的故事。
 */
export class StoryController {
    private boidSystem: BoidSystem;
    private config: StoryConfig;
    private currentScene: StoryScene = 'inactive';
    private sceneTime: number = 0;
    private initialBoids: Boid[] = [];
    private backgroundBoids: Boid[] = [];

    constructor(boidSystem: BoidSystem, config: StoryConfig) {
        this.boidSystem = boidSystem;
        this.config = config;
    }

    public start(): void {
        this.boidSystem.initializeBoids(this.config.totalBoidCount);
        this.boidSystem.boids.forEach((b, index) => {
            // 所有无人机从地面中心开始
            b.position.set(0, 250, 0);
            b.velocity.set(0, 0, 0);

            if (index < this.config.initialBoidCount) {
                this.initialBoids.push(b);
                b.isVisible = true;
                b.lightIntensity = 0.0; // 初始组直接点亮
            } else {
                this.backgroundBoids.push(b);
                b.isVisible = true; // 先设置为可见，但灯光为0，在黑暗中不可见
                b.lightIntensity = 0.0;
            }
            b.storyTarget = new Vector3(); // 为每个boid初始化storyTarget
        });

        this.currentScene = 'scene1_linesPulse';
        this.sceneTime = 0;
    }

    public stop(): void {
        this.currentScene = 'inactive';
        this.boidSystem.boids.forEach(b => {
            b.storyTarget = null;
            b.lightIntensity = 1.0;
        });
        this.initialBoids = [];
        this.backgroundBoids = [];
    }

    public update(deltaTime: number): void {
        if (this.currentScene === 'inactive') return;

        this.sceneTime += deltaTime;

        switch (this.currentScene) {
            case 'scene1_linesPulse':
                this.updateScene1_LinesPulse();
                if (this.sceneTime >= this.config.scene1_duration) {
                    this.currentScene = 'scene2_5g';
                    this.sceneTime = 0;
                }
                break;
            case 'scene2_5g':
                this.updateScene2_5g();
                if (this.sceneTime >= this.config.scene2_duration) {
                    this.currentScene = 'scene3_chips';
                    this.sceneTime = 0;
                }
                break;
            case 'scene3_chips':
                this.updateScene3_Chips();
                if (this.sceneTime >= this.config.scene3_duration) {
                    this.currentScene = 'scene4_whirlpoolSwarm';
                    this.sceneTime = 0;
                }
                break;
            case 'scene4_whirlpoolSwarm':
                this.updateScene4_WhirlpoolSwarm();
                if (this.sceneTime >= this.config.scene4_duration) {
                    this.stop(); // 故事结束
                }
                break;
        }
    }
    
    // here start the scene update methods
    // ================================ SCENE 1 ================================
    // basically in a sense, boids would need to be assigned to designated groups first, then pulse one by one
    private updateScene1_LinesPulse(): void {
        // draw shenzheng metro map out
        const metro_coord: any[][] = [[147.5,153],[147.53125,165.15625],[147.5625,177.3125],[147.59375,189.46875],[147.625,201.62498474121094],[147.65625,213.78125],[147.6875,225.9375],[147.71875,238.09375],[147.75,250.25],[147.78125,262.40625],[147.8125,274.5625],[147.84375,286.71875],[147.875,298.875],[147.90625,311.03125],[147.9375,323.1875],[147.96875,335.34375],[147,347.5],[140.0999984741211,356.5],[133.1999969482422,365.5],[126.30000305175781,374.5],[119.4000015258789,383.5],[112.5,392],[112.50000762939453,404.33331298828125],[112.50000762939453,416.66668701171875],[112.50000762939453,429],[112.50000762939453,441.33331298828125],[112.50000762939453,453.66668701171875],[112.50000762939453,466],[112.50000762939453,478.3333435058594],[112.50000762939453,490.6666564941406],[112.50000762939453,503],[112.50000762939453,515.3333435058594],[112.5,527.6666870117188],[112.5,540],[112.5,552.3333129882812],[112.5,564.6666870117188],[112.5,577],[112.5,589.3333129882812],[112.5,601.6666870117188],[111.77999877929688,614.219970703125],[119.1240005493164,623.3999633789062],[126.46800231933594,632.5799560546875],[133.81199645996094,641.760009765625],[141.15599822998047,650.9400024414062],[150.3800048828125,662.239990234375],[150.33200073242188,673.2520141601562],[150.28399658203125,684.2639770507812],[150.2360076904297,695.2760009765625],[150.18800354003906,706.2879638671875],[150.13999938964844,715.1799926757812],[159.15142822265625,724.5599975585938],[168.16285705566406,733.9400024414062],[177.17428588867188,743.3200073242188],[186.1857147216797,752.7000122070312],[195.1971435546875,762.0800170898438],[204.2085723876953,771.4600219726562],[214.3800048828125,779.9000244140625],[226.19857788085938,779.88427734375],[238.0171356201172,779.8685913085938],[249.83572387695312,779.8529052734375],[261.65428161621094,779.837158203125],[273.4728546142578,779.8214111328125],[285.29144287109375,779.8057250976562],[297.1099853515625,779.7900390625],[308.9285583496094,779.7742919921875],[320.74713134765625,779.7586059570312],[332.5657043457031,779.7428588867188],[344.38427734375,779.7271728515625],[356.2028503417969,779.71142578125],[368.02142333984375,779.6957397460938],[379.3599853515625,778.5],[389.9599914550781,768.1400146484375],[389.9599914550781,756.2933349609375],[389.9599914550781,744.4466552734375],[389.9599914550781,732.5999755859375],[389.9599914550781,720.7533569335938],[389.9599914550781,708.9066772460938],[390.4200134277344,696.3599853515625],[399.3599853515625,689.0599975585938],[411.6244201660156,688.8511352539062],[423.8888854980469,688.6422119140625],[436.1533203125,688.433349609375],[448.41778564453125,688.2244262695312],[460.6822204589844,688.0155639648438],[472.9466552734375,687.806640625],[485.2110900878906,687.5977783203125],[497.4755554199219,687.3888549804688],[509.0400085449219,686.719970703125],[515.3800048828125,695.4199829101562],[515.3800048828125,707.5399780273438],[514.6799926757812,720.3599853515625],[523.6199951171875,725.5399780273438],[535.3880004882812,725.9159545898438],[547.156005859375,726.2919921875],[558.9240112304688,726.66796875],[570.6920166015625,727.0440063476562],[121.72000122070312,193.5399932861328],[114.24500274658203,201.25999450683594],[106.77000427246094,208.97999572753906],[99.29499816894531,216.6999969482422],[91.81999969482422,225.39999389648438],[91.7844467163086,237.20889282226562],[91.74888610839844,249.01776123046875],[91.71333312988281,260.82666015625],[91.67778015136719,272.6355438232422],[91.64221954345703,284.4444274902344],[91.6066665649414,296.2533264160156],[91.57111358642578,308.0622253417969],[91.53555297851562,319.87109375],[91.81999969482422,332.6400146484375],[99.67333221435547,341.03668212890625],[107.52666473388672,349.433349609375],[115.3800048828125,357.83001708984375],[123.23333740234375,366.2266540527344],[131.086669921875,374.6233215332031],[139.9199981689453,382.0400085449219],[147.0800018310547,393.4200134277344],[147.1866683959961,407.28668212890625],[147.2933349609375,421.1533203125],[146.4199981689453,433.3999938964844],[153.97500610351562,442.010009765625],[161.52999877929688,450.6199951171875],[169.08499145507812,459.22998046875],[175.33999633789062,466.5400085449219],[175.6649932861328,479.01251220703125],[175.99000549316406,491.4850158691406],[176.31500244140625,503.95751953125],[176.63999938964844,516.4299926757812],[176.96499633789062,528.9025268554688],[177.29000854492188,541.375],[177.61500549316406,553.8475341796875],[176.97999572753906,568.5999755859375],[185.91000366210938,579],[195.8800048828125,587.52001953125],[195.90093994140625,599.6943359375],[195.92189025878906,611.8685913085938],[195.94285583496094,624.0428466796875],[195.96380615234375,636.2171630859375],[195.98475646972656,648.3914184570312],[196.00570678710938,660.5657348632812],[196.0266571044922,672.739990234375],[196.04762268066406,684.914306640625],[196.06857299804688,697.0885620117188],[196.0895233154297,709.2628784179688],[196.1104736328125,721.4371337890625],[196.1314239501953,733.6114501953125],[196.15237426757812,745.7857055664062],[196.17333984375,757.9600219726562],[196.1942901611328,770.13427734375],[196.21524047851562,782.30859375],[196.23619079589844,794.4828491210938],[196.25714111328125,806.6571655273438],[196.27810668945312,818.8314208984375],[196.29905700683594,831.0057373046875],[195.8800048828125,843.760009765625],[190.17999267578125,857.1199951171875],[181.73199462890625,865.5679931640625],[173.28399658203125,874.0159912109375],[164.83599853515625,882.4639892578125],[156.38800048828125,890.9119873046875],[83.56000137329102,275],[83.56000518798828,287.5355529785156],[83.56000518798828,300.07110595703125],[83.56000518798828,312.606689453125],[83.56000518798828,325.1422119140625],[83.56000518798828,337.67779541015625],[83.56000137329102,350.2133483886719],[83.56000137329102,362.7489013671875],[83.56000137329102,375.2844543457031],[83.56000137329102,385.55999755859375],[92.33332824707031,395.3399963378906],[101.1066665649414,405.1199951171875],[138.0999984741211,418.6600036621094],[138.2153778076172,430.9277038574219],[138.3307647705078,443.19537353515625],[138.4461441040039,455.46307373046875],[138.56153106689453,467.73077392578125],[138.67691802978516,479.99847412109375],[138.79230499267578,492.26617431640625],[138.90768432617188,504.53387451171875],[139.0230712890625,516.8015441894531],[139.13845825195312,529.0692443847656],[139.25384521484375,541.3369140625],[139.36922454833984,553.6046142578125],[139.48461151123047,565.872314453125],[138.4800033569336,577.3800048828125],[146.24666595458984,587.6599731445312],[154.01333618164062,597.9400024414062],[162.33999633789062,607.219970703125],[162.26571655273438,619.51708984375],[162.19143676757812,631.8142700195312],[162.1171417236328,644.1113891601562],[162.04286193847656,656.4085693359375],[161.9685821533203,668.7056884765625],[161.894287109375,681.0028686523438],[161.3000030517578,696.1400146484375],[167.52000427246094,707.2999877929688],[179.44000244140625,712.47998046875],[191.57400512695312,712.47998046875],[203.7080078125,712.47998046875],[215.84201049804688,712.47998046875],[227.9759979248047,712.47998046875],[240.11000061035156,712.47998046875],[252.24400329589844,712.47998046875],[264.37799072265625,712.47998046875],[276.5119934082031,712.47998046875],[288.64599609375,712.47998046875],[300.7799987792969,712.47998046875],[312.91400146484375,712.47998046875],[325.0480041503906,712.47998046875],[337.1820068359375,712.47998046875],[349.31597900390625,712.47998046875],[361.45001220703125,712.47998046875],[373.583984375,712.47998046875],[385.718017578125,712.47998046875],[397.85198974609375,712.47998046875],[409.9859924316406,712.47998046875],[423.9200134277344,711.7000122070312],[436.5246276855469,711.7000122070312],[449.1292419433594,711.7000122070312],[461.7338562011719,711.7000122070312],[474.3384704589844,711.7000122070312],[486.943115234375,711.7000122070312],[499.5477294921875,711.7000122070312],[512.15234375,711.7000122070312],[524.7569580078125,711.7000122070312],[537.361572265625,711.7000122070312],[549.9661865234375,711.7000122070312],[562.57080078125,711.7000122070312],[575.1754150390625,711.7000122070312],[587.260009765625,711.7000122070312],[597.6300048828125,700.6799926757812],[609.2999877929688,687.0800170898438],[609.5599975585938,676.6199951171875],[609.8200073242188,666.1600341796875],[609.0399780273438,655.7000122070312],[616.2999877929688,649.739990234375],[628.6099853515625,649.6099853515625],[645.0800170898438,653.6199951171875],[645.2510986328125,666.23779296875],[645.4222412109375,678.8555297851562],[645.5933227539062,691.4733276367188],[645.7644653320312,704.0911254882812],[645.935546875,716.7088623046875],[646.106689453125,729.32666015625],[646.2777709960938,741.9444580078125],[646.4489135742188,754.5621948242188],[126.44000244140625,192.82000732421875],[138.60800170898438,192.8820037841797],[150.77601623535156,192.94400024414062],[162.94400024414062,193.00601196289062],[175.11199951171875,193.06800842285156],[187.27999877929688,193.1300048828125],[199.447998046875,193.19200134277344],[211.6160125732422,193.25399780273438],[223.78399658203125,193.31600952148438],[235.95199584960938,193.3780059814453],[248.1199951171875,193.44000244140625],[260.2879943847656,193.5019989013672],[272.45599365234375,193.56399536132812],[284.6239929199219,193.62600708007812],[296.7919921875,193.68800354003906],[308.9599914550781,193.75],[321.12799072265625,193.81199645996094],[333.2959899902344,193.87399291992188],[345.4639892578125,193.93600463867188],[357.6319885253906,193.9980010986328],[371.8800048828125,194.05999755859375],[375.2200012207031,199.0800018310547],[375.4300231933594,209.3000030517578],[375.2200012207031,219.52000427246094],[366.63427734375,228.4057159423828],[358.048583984375,237.2914276123047],[349.4628601074219,246.17713928222656],[340.87713623046875,255.06285095214844],[332.2914123535156,263.9485778808594],[323.7057189941406,272.83428955078125],[314.2799987792969,282.1400146484375],[307.17999267578125,293.82000732421875],[307.5159912109375,305.343994140625],[307.85198974609375,316.8680114746094],[308.18798828125,328.3919982910156],[308.52398681640625,339.916015625],[308.8599853515625,350.17999267578125],[317.28363037109375,358.9072570800781],[325.707275390625,367.634521484375],[334.1308898925781,376.36181640625],[342.5545349121094,385.0890808105469],[350.9781799316406,393.81634521484375],[359.40179443359375,402.54364013671875],[367.825439453125,411.2709045410156],[376.24908447265625,419.9981689453125],[384.6727294921875,428.7254333496094],[393.0963439941406,437.4527282714844],[402.7799987792969,446.17999267578125],[402.9200134277344,458.8466491699219],[403.05999755859375,471.5133361816406],[403.20001220703125,482.0799865722656],[411.5022277832031,490.47552490234375],[419.804443359375,498.87109375],[428.106689453125,507.26666259765625],[436.4089050292969,515.6622314453125],[444.71112060546875,524.0577697753906],[453.0133361816406,532.4533081054688],[461.3155822753906,540.848876953125],[469.6177978515625,549.2444458007812],[479.5799865722656,558.47998046875],[492.41497802734375,559.10498046875],[505.25,559.72998046875],[518.0849914550781,560.35498046875],[531.760009765625,560.1400146484375],[540.1099853515625,568.5950317382812],[548.4599609375,577.050048828125],[556.8099975585938,585.5050048828125],[564.3200073242188,595.2000122070312],[564.36669921875,608.0488891601562],[564.413330078125,620.8978271484375],[564.4600219726562,633.7467041015625],[564.5066528320312,646.5955810546875],[564.5533447265625,659.4444580078125],[564.5999755859375,672.2933349609375],[564.6466674804688,685.1422729492188],[564.6932983398438,697.9911499023438],[135.1999969482422,853.1799926757812],[127.27333068847656,846.7799682617188],[119.34666442871094,840.3800048828125],[111,834.4000244140625],[111.31500244140625,820.7250366210938],[111.62999725341797,807.050048828125],[111.94499969482422,793.375],[115.18000030517578,780.5399780273438],[122.86000061035156,771.1919555664062],[130.54000091552734,761.843994140625],[138.22000122070312,752.4959716796875],[145.9000015258789,743.1480102539062],[156.0800018310547,731.7000122070312],[156.0800018310547,718.6900024414062],[156.0800018310547,705.6799926757812],[156.0800018310547,692.6700439453125],[156.0800018310547,679.6600341796875],[156.0800018310547,666.6500244140625],[155.24000549316406,654.0599975585938],[145.4300079345703,644.25],[136.45999908447266,633.2000122070312],[137.3000030517578,622.3400268554688],[146.48250579833984,613.3125],[155.66500854492188,604.2850341796875],[164.84750366210938,595.2575073242188],[174.02999877929688,586.22998046875],[183.21249389648438,577.2025146484375],[192.39498901367188,568.1749877929688],[201.57749938964844,559.1475219726562],[207.83999633789062,551.7999877929688],[218.07000732421875,547.4199829101562],[230.3800048828125,541.3599853515625],[242.13230895996094,541.2630615234375],[253.88461303710938,541.1661376953125],[265.6369323730469,541.0692138671875],[277.38922119140625,540.9722900390625],[289.14154052734375,540.8753662109375],[300.89385986328125,540.7784423828125],[312.6461486816406,540.6815185546875],[324.3984680175781,540.5845947265625],[336.1507568359375,540.4876708984375],[347.903076171875,540.3907470703125],[359.6553955078125,540.2938232421875],[371.40771484375,540.1968994140625],[383.5799865722656,539.7000122070312],[393.1099853515625,530.7233276367188],[402.6399841308594,521.7466735839844],[412.16998291015625,512.77001953125],[421.70001220703125,503.7933349609375],[431.2300109863281,494.816650390625],[441.17999267578125,487.5199890136719],[453.638427734375,487.2630615234375],[466.096923828125,487.0061340332031],[478.5553894042969,486.74920654296875],[491.01385498046875,486.4923095703125],[503.4722900390625,486.2353820800781],[515.9307861328125,485.97845458984375],[528.3892211914062,485.7215270996094],[540.8477172851562,485.464599609375],[553.30615234375,485.2076721191406],[565.7646484375,484.9507751464844],[578.2230834960938,484.69384765625],[590.6815795898438,484.4369201660156],[605.6400146484375,485],[614.927490234375,493.82000732421875],[624.2150268554688,502.6400146484375],[633.5025024414062,511.4599914550781],[642.7900390625,520.2799987792969],[652.0775146484375,529.1000061035156],[661.364990234375,537.9199829101562],[670.6525268554688,546.739990234375],[681.6199951171875,555.97998046875],[683.1599731445312,560.5999755859375],[683.2374877929688,573.0299682617188],[683.3150024414062,585.4599609375],[683.3925170898438,597.8899536132812],[683.469970703125,610.3199462890625],[683.5474853515625,622.75],[683.625,635.1799926757812],[683.7025146484375,647.6099853515625],[682.8400268554688,660.3599853515625],[676.1799926757812,668.9000244140625],[663.323974609375,669.092041015625],[650.468017578125,669.2839965820312],[637.6119995117188,669.4760131835938],[624.7560424804688,669.66796875],[1000,430.5],[987.9444580078125,430.27777099609375],[975.888916015625,430.0555419921875],[963.8333129882812,429.8333435058594],[951.7777709960938,429.6111145019531],[939.7222290039062,429.3888854980469],[927.6666870117188,429.1666564941406],[915.611083984375,428.9444580078125],[903.5555419921875,428.72222900390625],[880,415.5],[886,422.5],[879.5,413.5],[877.5,400.8333435058594],[875.5,388.1666564941406],[873.5,377],[866,370],[853.5,369.3333435058594],[841,368.6666564941406],[829,367.5],[817.5,366.5],[810.5,359],[800.5,351],[787.8333129882812,351.3333435058594],[775.1666870117188,351.6666564941406],[762.5,352],[749.8333129882812,352.3333435058594],[737.1666870117188,352.6666564941406],[723,353.5],[710.5,360.5],[711,371],[711.5,381.5],[709.5,391],[718.2142944335938,399.71429443359375],[726.9285888671875,408.4285583496094],[735.6428833007812,417.1428527832031],[744.3571166992188,425.8571472167969],[753.0714111328125,434.5714416503906],[761.7857055664062,443.28570556640625],[770.5,450.5],[777,465],[776.9000244140625,477.5],[776.7999877929688,490],[776.7000122070312,502.5],[776.5999755859375,515],[775.5,527.5],[784.375,536.625],[793.25,545.75],[802.125,554.875],[1000.5,606.5],[987.9444580078125,606.5],[975.388916015625,606.5],[962.8333129882812,606.5],[950.2777709960938,606.5],[937.7222290039062,606.5],[925.1666870117188,606.5],[912.611083984375,606.5],[900.0555419921875,606.5],[887,606],[877.9375,615],[868.875,624],[859.8125,633],[850.75,642],[841.6875,651],[832.625,660],[823.5625,669],[811,679],[799.04541015625,679.0681762695312],[787.0908813476562,679.1363525390625],[775.1363525390625,679.2045288085938],[763.1818237304688,679.272705078125],[751.227294921875,679.3408813476562],[739.272705078125,679.4091186523438],[727.3181762695312,679.477294921875],[715.3636474609375,679.5454711914062],[703.4090576171875,679.6136474609375],[691.4545288085938,679.6818237304688],[679.5,679.75],[667.5454711914062,679.8181762695312],[655.5908813476562,679.8863525390625],[643.6363525390625,679.9545288085938],[631.6818237304688,680.022705078125],[619.727294921875,680.0908813476562],[607.772705078125,680.1591186523438],[595.8181762695312,680.227294921875],[583.8636474609375,680.2954711914062],[571.9091186523438,680.3636474609375],[559.9545288085938,680.4318237304688],[550,681.5],[537.6666259765625,681.4166870117188],[525.3333129882812,681.3333129882812],[513,681.25],[500.6666564941406,681.1666870117188],[488.33331298828125,681.0833129882812],[476,681],[463.6666564941406,680.9166870117188],[451.3333435058594,680.8333129882812],[439,680.75],[426.6666564941406,680.6666870117188],[414.3333435058594,680.5833129882812],[399.5,679.5],[395,670],[395.5,650.5],[386.5,642.5],[373.58331298828125,642.25],[360.6666564941406,642],[347.75,641.75],[334.8333435058594,641.5],[321.9166564941406,641.25],[310,640.5],[297.5,650],[297.75,662.5625],[298,675.125],[298.25,687.6875],[298.5,700.25],[298.75,712.8125],[299,725.375],[299.25,737.9375],[298,753],[292,760.5],[279.3333435058594,760.5],[266.6666717529297,760.5],[252,760],[244.5,767],[244.7857208251953,779.0714111328125],[245.07142639160156,791.1428833007812],[245.35714721679688,803.2142944335938],[245.64285278320312,815.2857055664062],[245.92857360839844,827.3571166992188],[246.2142791748047,839.4285888671875],[245,852],[239,859],[232,865],[219.25,865],[206.5,865],[193.75,865],[181,865],[168.25,865],[155.5,863.5],[146.25,857.5],[134.5,758.5],[142.89999389648438,766.7999877929688],[151.3000030517578,775.0999755859375],[159.6999969482422,783.4000244140625],[168.10000610351562,791.7000122070312],[180.5,804],[194.75,803],[208,803.5],[214.5,796],[214.375,783],[214.25,770],[214.125,757],[214.5,741.5],[220.5,736.5],[231.625,736.75],[242.75,737],[253.875,737.25],[266.5,736.5],[271.5,741],[272,754.25],[271.5,767],[277.5,773.5],[289.5,773.5625],[301.5,773.625],[313.5,773.6875],[325.5,773.75],[337.5,773.8125],[349.5,773.875],[361.5,773.9375],[376,772.5],[383,765],[383.0714416503906,752.7857055664062],[383.1428527832031,740.5714111328125],[383.21429443359375,728.3571166992188],[383.28570556640625,716.1428833007812],[383.3571472167969,703.9285888671875],[383.4285583496094,691.7142944335938],[383.5,679.5],[383.5714416503906,667.2857055664062],[383.6428527832031,655.0714111328125],[383.71429443359375,642.8571166992188],[383.78570556640625,630.642822265625],[383.8571472167969,618.4285888671875],[383.9285583496094,606.2142944335938],[383.5,592],[390.5,584.75],[397.5,577.5],[409.70001220703125,577.5333251953125],[421.8999938964844,577.566650390625],[434.1000061035156,577.5999755859375],[446.29998779296875,577.6333618164062],[458.5,577.6666870117188],[470.70001220703125,577.7000122070312],[482.8999938964844,577.7333374023438],[495.1000061035156,577.7666625976562],[507.29998779296875,577.7999877929688],[519.5,577.8333129882812],[531.7000122070312,577.8666381835938],[543.9000244140625,577.9000244140625],[556.0999755859375,577.933349609375],[568.2999877929688,577.9666748046875],[582.5,577],[589,584.75],[594.5,594],[594.5833129882812,606.3333740234375],[594.6666870117188,618.6666870117188],[594.75,631],[594.8333129882812,643.3333129882812],[594.9166870117188,655.6666870117188],[595,668],[595.0833129882812,680.3333129882812],[595.1666870117188,692.6666870117188],[595.25,705],[595.3333129882812,717.3333129882812],[595.4166870117188,729.6666870117188],[594.5,743.5],[609,754],[621.1666870117188,754.4166870117188],[633.3333129882812,754.8333129882812],[645.5,755.25],[657.6666870117188,755.6666870117188],[669.8333129882812,756.0833129882812],[277.5,134.5],[277.70001220703125,147.9000015258789],[277.8999938964844,161.3000030517578],[278.1000061035156,174.6999969482422],[278.29998779296875,188.10000610351562],[277,202],[282.5,214],[290.72222900390625,222.11111450195312],[298.9444580078125,230.22222900390625],[307.16668701171875,238.33334350585938],[315.3888854980469,246.44444274902344],[323.6111145019531,254.55555725097656],[331.8333435058594,262.6666717529297],[340.0555419921875,270.77777099609375],[348.27777099609375,278.8888854980469],[356.5,286],[357.5,303.5],[348.81817626953125,312.4090881347656],[340.1363525390625,321.31817626953125],[331.4545593261719,330.2272644042969],[322.7727355957031,339.1363525390625],[314.0909118652344,348.0454406738281],[305.4090881347656,356.95452880859375],[296.7272644042969,365.8636474609375],[288.04547119140625,374.7727355957031],[279.3636474609375,383.68182373046875],[270.68182373046875,392.5909118652344],[262,401.5],[253.5,415.5],[253.43748474121094,427.75],[253.37498474121094,440],[253.31248474121094,452.2500305175781],[253.24998474121094,464.5],[253.18748474121094,476.75],[253.125,489],[253.0625,501.25],[253,513.5],[252.9375,525.75],[252.875,538],[252.8125,550.25],[252.75,562.5],[252.6875,574.75],[252.625,587],[252.5625,599.25],[252.5,611.5],[252.4375,623.75],[252.375,636],[252.3125,648.25],[252.25,660.5],[252.1875,672.75],[252.125,685],[252.0625,697.25],[252,709.5],[252.21429443359375,722.4285888671875],[252.42857360839844,735.357177734375],[252.64285278320312,748.2857055664062],[252.85714721679688,761.2142944335938],[253.07142639160156,774.1428833007812],[253.2857208251953,787.0714111328125],[252,800],[262.25,809],[271.5,818.5],[272,832.25],[271,844.5],[264.3333282470703,853],[257.6666717529297,861.5],[250,869],[368.5,511],[356.9166564941406,511.0833435058594],[345.3333435058594,511.1666564941406],[333.75,511.25],[322.1666564941406,511.3333435058594],[310.5833435058594,511.4166564941406],[299.5,511],[289.5,521.5],[289.75,535.125],[290,548.75],[290.25,562.375],[288.5,575],[298,585.75],[306,596.5],[306.4166564941406,609.0833129882812],[306.8333435058594,621.6666870117188],[307.25,634.25],[307.6666564941406,646.8333129882812],[308.0833435058594,659.4166870117188],[306.5,669],[320,681],[332.625,681.125],[345.25,681.25],[357.875,681.375],[371,681.5],[376,689],[376.20001220703125,700.5],[376.3999938964844,712],[376.6000061035156,723.5],[376.79998779296875,735],[375,744.5],[383.75,750.5],[390.5,754.5],[402.2727355957031,754.5454711914062],[414.04547119140625,754.5908813476562],[425.81817626953125,754.6363525390625],[437.5909118652344,754.6818237304688],[449.3636474609375,754.727294921875],[461.1363525390625,754.772705078125],[472.9090881347656,754.8181762695312],[484.68182373046875,754.8636474609375],[496.45452880859375,754.9091186523438],[508.2272644042969,754.9545288085938],[518,754],[526.75,749.25],[532.5,742.5],[532.5999755859375,730.9000244140625],[532.7000122070312,719.2999877929688],[532.7999877929688,707.7000122070312],[532.9000244140625,696.0999755859375],[533,684.5],[533.0999755859375,672.9000244140625],[533.2000122070312,661.2999877929688],[533.2999877929688,649.7000122070312],[533.4000244140625,638.0999755859375],[534.5,625],[542.75,617.25],[551,609.5],[559.25,601.75],[564,596],[576.1500244140625,596.0999755859375],[588.2999877929688,596.2000122070312],[600.4500122070312,596.2999877929688],[612.5999755859375,596.4000244140625],[624.75,596.5],[636.9000244140625,596.5999755859375],[649.0499877929688,596.7000122070312],[661.2000122070312,596.7999877929688],[673.3499755859375,596.9000244140625],[417.55999755859375,136.44000244140625],[408.79998779296875,145.38999938964844],[400.03997802734375,154.3400115966797],[391.2799987792969,163.29000854492188],[383.6400146484375,172.6199951171875],[383.4049987792969,185.4324951171875],[383.1700134277344,198.2449951171875],[382.93499755859375,211.0574951171875],[382.70001220703125,223.8699951171875],[382.4649963378906,236.6824951171875],[382.2300109863281,249.4949951171875],[381.9949951171875,262.3074951171875],[381.760009765625,274.36000061035156],[373.7200012207031,284.1600036621094],[365.6800231933594,293.96002197265625],[552.0999755859375,315.05999755859375],[539.6649780273438,315.25],[527.22998046875,315.44000244140625],[514.7949829101562,315.6300048828125],[501.6000061035156,316.20001220703125],[493.067138671875,324.43572998046875],[484.5343017578125,332.67144775390625],[476.0014343261719,340.9071350097656],[467.46856689453125,349.1428527832031],[458.93572998046875,357.3785705566406],[450.4028625488281,365.6142883300781],[441.8699951171875,373.8500061035156],[433.337158203125,382.0857238769531],[424.8042907714844,390.3214416503906],[416.27142333984375,398.5571594238281],[407.73858642578125,406.7928466796875],[399.2057189941406,415.028564453125],[390.6728515625,423.2642822265625],[382.1400146484375,431.8800048828125],[380.82000732421875,442.42999267578125],[378.760009765625,453.3599853515625],[387.7622375488281,462.0688781738281],[396.76446533203125,470.77777099609375],[405.76666259765625,479.4866638183594],[414.7688903808594,488.195556640625],[423.7711181640625,496.9044189453125],[432.7733459472656,505.6133117675781],[441.7755432128906,514.3222045898438],[450.77777099609375,523.0310974121094],[459.0199890136719,528.739990234375],[458.92498779296875,541.2224731445312],[458.8299865722656,553.7050170898438],[458.7349853515625,566.1875],[458.6399841308594,578.6699829101562],[458.54498291015625,591.1525268554688],[458.45001220703125,603.635009765625],[458.3550109863281,616.1174926757812],[458.260009765625,628.5999755859375],[458.1650085449219,641.08251953125],[458.07000732421875,653.5650024414062],[457.9750061035156,666.0474853515625],[457.8800048828125,678.530029296875],[457.7850036621094,691.0125122070312],[457.69000244140625,703.4949951171875],[457.5950012207031,715.9775390625],[457.5,726.5800170898438],[464.47998046875,734.1099853515625],[471.0799865722656,741.260009765625],[470.9849853515625,752.6600341796875],[470.8899841308594,764.0599975585938],[470.7950134277344,775.4599609375],[419.82000732421875,793.6400146484375],[419.88909912109375,781],[419.95819091796875,768.3599853515625],[420.02728271484375,755.719970703125],[420.09637451171875,743.0800170898438],[420.16546630859375,730.4400024414062],[420.23455810546875,717.7999877929688],[420.3036193847656,705.1599731445312],[420.3727111816406,692.5199584960938],[420.4418029785156,679.8800048828125],[420.5108947753906,667.239990234375],[419.82000732421875,653.8400268554688],[435.2799987792969,644.4199829101562],[447.833740234375,644.3499755859375],[460.38751220703125,644.2799682617188],[472.94122314453125,644.2099609375],[485.4949951171875,644.1400146484375],[498.04876708984375,644.0700073242188],[510.6025085449219,644],[523.15625,643.9299926757812],[535.7100219726562,643.8599853515625],[548.2637329101562,643.7899780273438],[560.8175048828125,643.719970703125],[573.3712768554688,643.6499633789062],[585.9249877929688,643.5800170898438],[598.478759765625,643.510009765625],[611.0325317382812,643.4400024414062],[623.5862426757812,643.3699951171875],[634.9000244140625,642.239990234375],[645,637],[645.111083984375,625.1377563476562],[645.2222290039062,613.2755737304688],[645.3333129882812,601.413330078125],[645.4444580078125,589.5510864257812],[645.5555419921875,577.6889038085938],[645.6666870117188,565.82666015625],[645.7777709960938,553.9644165039062],[645.888916015625,542.1022338867188],[645.239990234375,528.760009765625],[653.9199829101562,520.3485717773438],[662.5999755859375,511.9371337890625],[671.280029296875,503.5257263183594],[679.9600219726562,495.1142883300781],[688.6400146484375,486.7028503417969],[697.3200073242188,478.29144287109375],[706,469.8800048828125],[714.6799926757812,461.46856689453125],[723.3599853515625,453.05712890625],[732.0400390625,444.6457214355469],[740.7200317382812,436.2342834472656],[749.4000244140625,427.8228759765625],[758.0800170898438,419.41143798828125],[766,412.239990234375],[774.5333251953125,403.6746520996094],[783.066650390625,395.10931396484375],[791.5999755859375,386.54400634765625],[800.13330078125,377.9786682128906],[808.6666870117188,369.413330078125],[817.2000122070312,360.8479919433594],[825.7333374023438,352.28265380859375],[834.2666625976562,343.71734619140625],[842.7999877929688,335.1520080566406],[851.3333129882812,326.586669921875],[859.86669921875,318.0213317871094],[868.4000244140625,309.45599365234375],[876.933349609375,300.89068603515625],[885.4666748046875,292.3253479003906],[892.239990234375,285.239990234375],[899.1199951171875,278],[964.239990234375,334.5],[955.7636108398438,342.9545593261719],[947.2872924804688,351.4090881347656],[938.8109130859375,359.8636474609375],[930.3345336914062,368.31817626953125],[921.858154296875,376.7727355957031],[913.3818359375,385.2272644042969],[904.9054565429688,393.68182373046875],[896.4290771484375,402.1363525390625],[887.9526977539062,410.5909118652344],[879.4763793945312,419.0454406738281],[871.760009765625,427],[859.0716552734375,427.2699890136719],[846.3833618164062,427.5400085449219],[833.6950073242188,427.80999755859375],[821.0066528320312,428.0799865722656],[808.318359375,428.3500061035156],[795.6300048828125,428.6199951171875],[782.941650390625,428.8899841308594],[770.2533569335938,429.1600036621094],[757.5650024414062,429.42999267578125],[744.8766479492188,429.6999816894531],[732.1883544921875,429.9700012207031],[718.239990234375,430.760009765625],[709.3828735351562,439.7943115234375],[700.5256958007812,448.8285827636719],[691.6685791015625,457.86285400390625],[682.8114013671875,466.89715576171875],[673.9542846679688,475.9314270019531],[665.0971069335938,484.9657287597656],[656.760009765625,495],[656.5,511],[648.08447265625,519.3599853515625],[639.6688842773438,527.7200012207031],[631.2533569335938,536.0800170898438],[622.8377685546875,544.4400024414062],[614.4222412109375,552.7999877929688],[606.0066528320312,561.1599731445312],[597.5911254882812,569.52001953125],[589.175537109375,577.8800048828125],[581,584.239990234375],[568.75,586.8699951171875],[558,589.239990234375],[549.2999877929688,598.3919677734375],[540.5999755859375,607.5440063476562],[531.8999938964844,616.6959838867188],[523.2000122070312,625.8480224609375],[514.5,633.239990234375],[514.2533264160156,645.0800170898438],[514.0066833496094,656.9199829101562],[497.760009765625,673],[514.5,671.5],[629.5,372],[617.8699951171875,371.8800048828125],[607.239990234375,371.5],[593.760009765625,382],[593.6300048828125,395],[593.239990234375,410.760009765625],[584.760009765625,417.5],[572.0066528320312,417.6233215332031],[559.2533569335938,417.7466735839844],[546.5,417.8699951171875],[533.7466430664062,417.9933166503906],[520.9933166503906,418.1166687011719],[507.760009765625,417.5],[496.239990234375,426.239990234375],[496.2688903808594,439.0755615234375],[496.2977600097656,451.9111022949219],[496.32666015625,464.7466735839844],[496.3555603027344,477.58221435546875],[496.3844299316406,490.41778564453125],[496.413330078125,503.2533264160156],[496.4422302246094,516.0888977050781],[496.4710998535156,528.9244689941406],[482.760009765625,781.760009765625],[482.760009765625,768.2533569335938],[482.760009765625,754.7466430664062],[482.760009765625,741],[489.8800048828125,733.3800048828125],[495.760009765625,725.760009765625],[495.9666748046875,713.3400268554688],[496.17333984375,700.9199829101562],[496.3800048828125,688.5],[496.586669921875,676.0800170898438],[496.7933349609375,663.6599731445312],[496.239990234375,541.760009765625],[496.1685791015625,549.491455078125],[496.0971374511719,557.222900390625],[496.02569580078125,564.9542846679688],[495.95428466796875,572.6857299804688],[495.8828430175781,580.4171752929688],[495.8114318847656,588.1485595703125],[495.739990234375,595.8800048828125],[495.6685791015625,603.6114501953125],[495.5971374511719,611.3428344726562],[495.52569580078125,619.0742797851562],[495.45428466796875,626.8057250976562],[495.3828430175781,634.5371704101562],[495.3114318847656,642.2685546875]];
        const progress = this.sceneTime / this.config.scene1_duration

        this.boidSystem.boids.forEach((boid, i) => {
            // show factory
            const targetX = (metro_coord[i][0] - 500) * 0.75; // center the shape and scale
            const targetY = (800 - metro_coord[i][1]) * 0.75 + 100; // flip the y axis and scale
            const targetZ = 0;
            boid.storyTarget = new Vector3();
            // go to position
            boid.storyTarget!.set(targetX, targetY, targetZ);
            boid.isVisible = true;
            // lines pulsing in sinosidal period
            // boid.lightIntensity = 1;
            boid.lightIntensity = Math.sin(progress * Math.PI * this.config.scene1_duration/3 + 3* Math.PI/2 * i/this.boidSystem.boids.length) * 0.5 + 0.5; // fade in effect
            
        });
    }

    // ================================ SCENE 2 ================================
    private updateScene2_5g(): void {
        const progress = this.sceneTime / this.config.scene2_duration
        const drone_coord: any[][] = [[214.88000106811523,228.32000160217285],[220.45412063598633,226.37779426574707],[226.02825355529785,224.43560028076172],[231.60238647460938,222.49339294433594],[237.17650604248047,220.55118560791016],[242.750638961792,218.60897827148438],[248.32477188110352,216.6667709350586],[253.8988914489746,214.72457695007324],[255.0600128173828,209.64678382873535],[255.0600128173828,203.74399185180664],[255.0600128173828,197.8411865234375],[255.0600128173828,191.93838119506836],[255.0600128173828,186.03557586669922],[255.0600128173828,180.1327838897705],[255.0600128173828,174.2299919128418],[254.46905136108398,168.36856269836426],[252.61248016357422,162.7780475616455],[249.57783126831055,157.72890663146973],[245.5191535949707,153.45906257629395],[240.63108444213867,150.17116355895996],[235.14302825927734,148.03055381774902],[229.3192901611328,147.14356422424316],[223.41683197021484,147.1200122833252],[217.5140266418457,147.1200122833252],[211.61122131347656,147.1200122833252],[205.70842933654785,147.1200122833252],[199.8056240081787,147.1200122833252],[193.90283203125,147.1200122833252],[188.00002670288086,147.11999893188477],[182.09722137451172,147.11999893188477],[176.194429397583,147.11999893188477],[170.29162406921387,147.11999893188477],[164.38883209228516,147.11999893188477],[158.48602676391602,147.11999893188477],[152.58322143554688,147.11999893188477],[146.6807632446289,147.1435375213623],[140.85701179504395,148.03055381774902],[135.36895561218262,150.17116355895996],[130.48087310791016,153.45906257629395],[126.42219543457031,157.7288932800293],[123.38753986358643,162.77802085876465],[121.53099536895752,168.3685760498047],[120.94000720977783,174.22997856140137],[120.94000720977783,180.1327838897705],[120.94000720977783,186.0355625152588],[120.94000720977783,191.93836784362793],[120.94000053405762,197.84117317199707],[120.94000053405762,203.7439785003662],[120.94000053405762,209.64678382873535],[122.10110187530518,214.7245635986328],[127.67522811889648,216.6667709350586],[133.249361038208,218.60897827148438],[138.82349395751953,220.55118560791016],[144.39762687683105,222.49339294433594],[149.97173309326172,224.4355869293213],[155.54586601257324,226.37779426574707],[161.11999893188477,228.32000160217285],[161.7430305480957,234.0998935699463],[163.5984401702881,239.6089382171631],[166.5996971130371,244.58754348754883],[170.59821319580078,248.80742645263672],[175.4071750640869,252.07366943359375],[180.80687141418457,254.22677612304688],[186.54451942443848,255.1611099243164],[192.3496856689453,254.8498077392578],[197.95170974731445,253.29754257202148],[203.08568572998047,250.57069778442383],[207.514799118042,246.80527114868164],[211.03597450256348,242.17963790893555],[213.47976875305176,236.90512466430664],[214.72463035583496,231.2268238067627],[214.72463035583496,225.41323280334473],[213.47976875305176,219.73491859436035],[211.03597450256348,214.4603786468506],[207.514799118042,209.83477210998535],[203.0856990814209,206.06933212280273],[197.95172309875488,203.3425006866455],[192.3496856689453,201.79027557373047],[186.54451942443848,201.4788932800293],[180.806884765625,202.41328048706055],[175.4071750640869,204.56634712219238],[170.59821319580078,207.83260345458984],[166.5996971130371,212.05248641967773],[163.5984401702881,217.03107833862305],[161.7430305480957,222.54013633728027],[120.94000053405762,174.55999946594238],[115.06875133514404,174.5600128173828],[109.19750213623047,174.5600128173828],[103.32624626159668,174.55999946594238],[97.45500373840332,174.55999946594238],[91.58374786376953,174.55999946594238],[85.71249866485596,174.55999946594238],[79.84124946594238,174.55999946594238],[73.97000026702881,174.55999946594238],[68.09875106811523,174.55999946594238],[62.22750186920166,174.55999946594238],[56.356252670288086,174.55999946594238],[50.4849967956543,174.55999946594238],[44.61374759674072,174.55999946594238],[38.74249839782715,174.55999946594238],[32.871249198913574,174.55999946594238],[349,174.55999946594238],[343.12875747680664,174.5600128173828],[337.2575149536133,174.5600128173828],[331.38624572753906,174.55999946594238],[325.5150032043457,174.55999946594238],[319.64376068115234,174.55999946594238],[313.7724914550781,174.55999946594238],[307.90124893188477,174.55999946594238],[302.0300064086914,174.55999946594238],[296.15876388549805,174.55999946594238],[290.2875213623047,174.55999946594238],[284.41625213623047,174.55999946594238],[278.5450096130371,174.55999946594238],[272.67376708984375,174.55999946594238],[266.80249786376953,174.55999946594238],[260.9312553405762,174.55999946594238],[27,107.5],[32.74999809265137,107.5],[38.50000286102295,107.5],[44.250000953674316,107.5],[49.999999046325684,107.5],[55.75000047683716,107.5],[61.499998569488525,107.5],[67.25,107.5],[73.00000143051147,107.5],[78.74999618530273,107.5],[84.50000095367432,107.5],[90.24999904632568,107.5],[95.99999713897705,107.5],[101.75000190734863,107.5],[268.5,107.5],[274.24998474121094,107.5],[279.99999618530273,107.5],[285.75000762939453,107.5],[291.49999237060547,107.5],[297.25000381469727,107.5],[302.9999885559082,107.5],[308.75,107.5],[314.5000114440918,107.5],[320.24999618530273,107.5],[326.00000762939453,107.5],[331.74999237060547,107.5],[337.50000381469727,107.5],[343.25001525878906,107.5],[67.32000160217285,107.5],[67.32000494003296,113.59636116027832],[67.32000494003296,119.69272899627686],[67.32000494003296,125.78909015655518],[67.32000494003296,131.8854579925537],[67.32000160217285,137.98181915283203],[67.32000160217285,144.07818031311035],[67.32000160217285,150.17454147338867],[67.32000160217285,156.27091598510742],[67.32000160217285,162.36727714538574],[67.32000160217285,168.46363830566406],[308.8199882507324,107.5],[308.8199882507324,113.59636116027832],[308.8199882507324,119.69272899627686],[308.8199882507324,125.78909015655518],[308.8199882507324,131.8854579925537],[308.8199882507324,137.98181915283203],[308.8199882507324,144.07818031311035],[308.8199882507324,150.17454147338867],[308.8199882507324,156.27091598510742],[308.8199882507324,162.36727714538574],[308.8199882507324,168.46363830566406],[67.32000160217285,268.5],[73.38079786300659,268.5],[79.44159412384033,268.5],[85.50239372253418,268.5],[91.56318664550781,268.5],[94.05999946594238,264.93601989746094],[94.05999946594238,258.8752136230469],[94.05999946594238,252.8144073486328],[94.05999946594238,246.7536277770996],[94.05999946594238,240.69282150268555],[94.05999946594238,234.6320285797119],[94.05999946594238,228.57123565673828],[99.25623321533203,225.7218780517578],[104.67717170715332,223.01141548156738],[110.09811687469482,220.30093955993652],[115.51905536651611,217.5904769897461],[308.8199882507324,268.5],[303.1074676513672,268.5],[297.3949737548828,268.5],[291.6824531555176,268.5],[285.96993255615234,268.5],[281.9399871826172,266.8174247741699],[281.9399871826172,261.10493087768555],[281.9399871826172,255.3924102783203],[281.9399871826172,249.67988967895508],[281.9399871826172,243.96738243103027],[281.9399871826172,238.25487518310547],[281.9399871826172,232.54235458374023],[280.60713958740234,227.65357780456543],[275.49773025512695,225.0988597869873],[270.3882942199707,222.5441551208496],[265.27885818481445,219.98943710327148],[260.16944885253906,217.43471908569336]];

        // only use 200 boids for drones
        this.boidSystem.boids.forEach((boid, i) => {
            boid.lightIntensity = 1;
            boid.isVisible = true;
            if (i >= 200) {
                // move from og pos 
                boid.storyTarget!.set(0, 30, 0);
            }
            else {
                // show drone
                const targetX = (drone_coord[i][0] - 200) * 1.5; // center the shape and scale
                const targetY = (300 - drone_coord[i][1]) * 1.5 + 200; // flip the y axis and scale
                const targetZ = 0;
                boid.storyTarget = new Vector3();
                // go to position
                boid.storyTarget!.set(targetX, targetY, targetZ);
            }

        });
    }

    // ================================ SCENE 3 ================================
    private updateScene3_Chips(): void {
        const progress = this.sceneTime / this.config.scene3_duration
        // only use 200 boids for drones
        const chip_coord: any[][] = [[101,101],[111.28570938110352,101],[121.57143592834473,101],[131.85714530944824,101],[142.14285469055176,101],[152.42858123779297,101],[162.71429061889648,101],[173,101],[183.28570938110352,101],[193.57141876220703,101],[203.85714530944824,101],[214.14285469055176,101],[224.42858123779297,101],[234.71429061889648,101],[245,101],[255.28570938110352,101],[265.5714359283447,101],[275.85714530944824,101],[286.14285469055176,101],[296.4285640716553,101],[306.7142906188965,101],[317,101],[327.2857093811035,101],[337.57141876220703,101],[347.85716247558594,101],[358.14283752441406,101],[368.42858123779297,101],[371,108.71429061889648],[371,119],[371,129.28570938110352],[371,139.57141876220703],[371,149.85712814331055],[371,160.14287185668945],[371,170.42858123779297],[371,180.71429061889648],[371,191],[371,201.28570938110352],[371,211.57141876220703],[371,221.85712814331055],[371,232.14287185668945],[371,242.42858123779297],[371,252.71429061889648],[371,263],[371,273.2857093811035],[371,283.57141876220703],[371,293.85712814331055],[371,304.14287185668945],[371,314.42858123779297],[371,324.7142906188965],[371,335],[371,345.2857093811035],[371,355.57141876220703],[371,365.85712814331055],[365.85712814331055,371.0000343322754],[355.57141876220703,371.0000343322754],[345.2857093811035,371.0000343322754],[335,371.0000343322754],[324.7142562866211,371.0000343322754],[314.42858123779297,371.0000343322754],[304.14283752441406,371.0000343322754],[293.85716247558594,371],[283.57141876220703,371],[273.2857437133789,371],[263,371],[252.7142562866211,371],[242.42858123779297,371],[232.14283752441406,371],[221.85716247558594,371],[211.57141876220703,371],[201.2857437133789,371],[191,371],[180.7142562866211,371],[170.42858123779297,371],[160.14283752441406,371],[149.85716247558594,371],[139.57141876220703,371],[129.2857437133789,371],[119,371],[108.7142562866211,371],[101.00000858306885,368.42858123779297],[101.00000858306885,358.14283752441406],[101.00000858306885,347.85716247558594],[101.00000858306885,337.57141876220703],[101.00000858306885,327.2857437133789],[101.00000858306885,317],[101.00000858306885,306.7142562866211],[101.00000858306885,296.42858123779297],[101.00000858306885,286.14283752441406],[101.00000858306885,275.85716247558594],[101.00000858306885,265.57141876220703],[101.00000858306885,255.2857437133789],[101.00000858306885,245],[101.00000858306885,234.7142562866211],[101.00000858306885,224.42858123779297],[101.00000858306885,214.14283752441406],[101.00000858306885,203.85716247558594],[101,193.57141876220703],[101,183.2857437133789],[101,173],[101,162.7142562866211],[101,152.42858123779297],[101,142.14283752441406],[101,131.85716247558594],[101,121.57141876220703],[101,111.2857437133789],[182,182],[192.28570938110352,182],[202.57141876220703,182],[212.85714530944824,182],[223.14285469055176,182],[233.42858123779297,182],[243.71429061889648,182],[254,182],[264.2857093811035,182],[274.57141876220703,182],[284.85714530944824,182],[290,187.14285469055176],[290,197.42858123779297],[290,207.71429061889648],[290,218],[290,228.28570938110352],[290,238.57143592834473],[290,248.85714530944824],[290,259.14285469055176],[290,269.4285640716553],[290,279.7142906188965],[290,290],[279.7142906188965,290],[269.4285640716553,290],[259.14285469055176,290],[248.85714530944824,290],[238.57143592834473,290],[228.28570938110352,290],[218,290],[207.71429061889648,290],[197.42858123779297,290],[187.14287185668945,290],[182,284.85712814331055],[182,274.57141876220703],[182,264.2857093811035],[182,254],[182,243.71429061889648],[182,233.42858123779297],[182,223.14287185668945],[182,212.85712814331055],[182,202.57141876220703],[182,192.28570938110352],[164,443],[164,432.9585647583008],[164,422.91712951660156],[164,412.87569427490234],[164,402.8342933654785],[164,392.7928581237793],[164,382.7514228820801],[236,443],[236,432.9585647583008],[236,422.91712951660156],[236,412.87569427490234],[236,402.8342933654785],[236,392.7928581237793],[236,382.7514228820801],[308,443],[308,432.9585647583008],[308,422.91712951660156],[308,412.87569427490234],[308,402.8342933654785],[308,392.7928581237793],[308,382.7514228820801],[164,101],[164,90.71428632736206],[164,80.42857265472412],[164,70.14285469055176],[164,59.85714101791382],[164,49.57142734527588],[164,39.28571367263794],[236,100.09999656677246],[236,89.94285297393799],[236,79.78570938110352],[236,69.62857007980347],[236,59.471426486968994],[236,49.31428289413452],[236,39.15714359283447],[308,101],[308,90.71428632736206],[308,80.42857265472412],[308,70.14285469055176],[308,59.85714101791382],[308,49.57142734527588],[308,39.28571367263794],[443,308],[432.7142906188965,308],[422.42858123779297,308],[412.14283752441406,308],[401.85712814331055,308],[391.57141876220703,308],[381.2857093811035,308],[443,236],[432.7142906188965,236],[422.42858123779297,236],[412.14283752441406,236],[401.85712814331055,236],[391.57141876220703,236],[381.2857093811035,236],[443,164],[432.7142906188965,164],[422.42858123779297,164],[412.14283752441406,164],[401.85712814331055,164],[391.57141876220703,164],[381.2857093811035,164],[101,308],[90.71428632736206,308],[80.42857265472412,308],[70.14285469055176,308],[59.85714101791382,308],[49.57142734527588,308],[39.28571367263794,308],[99.82999897003174,236],[89.71142768859863,236],[79.59285640716553,236],[69.47428512573242,236],[59.355713844299316,236],[49.23714256286621,236],[39.118571281433105,236],[101,164],[90.71428632736206,164],[80.42857265472412,164],[70.14285469055176,164],[59.85714101791382,164],[49.57142734527588,164],[39.28571367263794,164],[20,20],[30.224838256835938,20],[40.449710845947266,20],[50.6745491027832,20],[60.89942169189453,20],[71.12425994873047,20],[81.3490982055664,20],[91.57397079467773,20],[101.79880905151367,20],[112.023681640625,20],[122.24851989746094,20],[132.47335815429688,20],[142.6982307434082,20],[152.92306900024414,20],[163.14794158935547,20],[173.3727798461914,20],[183.59763526916504,20],[193.82249069213867,20],[204.0473289489746,20],[214.27218437194824,20],[224.49703979492188,20],[234.7218952178955,20],[244.94675064086914,20],[255.17160606384277,20],[265.3964443206787,20],[275.62129974365234,20],[285.846155166626,20],[296.0710105895996,20],[306.29586601257324,20],[316.5207214355469,20],[326.7455596923828,20],[336.97039794921875,20],[347.1952705383301,20],[357.420108795166,20],[367.64498138427734,20],[377.8698196411133,20],[388.0946578979492,20],[398.31953048706055,20],[408.5443687438965,20],[418.7692413330078,20],[428.99407958984375,20],[439.2189178466797,20],[449.443790435791,20],[452.0000343322754,27.668628692626953],[452.0000343322754,37.89350128173828],[452.0000343322754,48.11833953857422],[452.0000343322754,58.34321212768555],[452,68.56805038452148],[452,78.79288864135742],[452,89.01776123046875],[452,99.24259948730469],[452,109.46747207641602],[452,119.69231033325195],[452,129.9171485900879],[452,140.14202117919922],[452,150.36685943603516],[452,160.59173202514648],[452,170.81653594970703],[452,181.04144287109375],[452,191.2662811279297],[452,201.49111938476562],[452,211.71595764160156],[452,221.9407958984375],[452,232.16570281982422],[452,242.39054107666016],[452,252.6153793334961],[452,262.84021759033203],[452,273.06505584716797],[452,283.2899627685547],[452,293.5148010253906],[452,303.73963928222656],[452,313.9644775390625],[452,324.18931579589844],[452,334.41422271728516],[452,344.6390609741211],[452,354.86389923095703],[452,365.08873748779297],[452,375.3135757446289],[452,385.5384826660156],[452,395.76332092285156],[452,405.9881591796875],[452,416.21299743652344],[452,426.4378356933594],[452,436.6627426147461],[452,446.88758087158203],[446.88758087158203,452.0000343322754],[436.6627426147461,452.0000343322754],[426.4378356933594,452.0000343322754],[416.21299743652344,452.0000343322754],[405.9881591796875,452.0000343322754],[395.76332092285156,452.0000343322754],[385.5384826660156,452.0000343322754],[375.3135757446289,452.0000343322754],[365.08873748779297,452.0000343322754],[354.86389923095703,452.0000343322754],[344.6390609741211,452.0000343322754],[334.41422271728516,452.0000343322754],[324.18931579589844,452.0000343322754],[313.9644775390625,452.0000343322754],[303.73963928222656,452.0000343322754],[293.5148010253906,452.0000343322754],[283.2899627685547,452.0000343322754],[273.06505584716797,452.0000343322754],[262.84021759033203,452.0000343322754],[252.6153793334961,452.0000343322754],[242.39054107666016,452.0000343322754],[232.16570281982422,452.0000343322754],[221.9407958984375,452.0000343322754],[211.71595764160156,452],[201.49111938476562,452],[191.2662811279297,452],[181.04144287109375,452],[170.81653594970703,452],[160.59176635742188,452],[150.36692810058594,452],[140.14195251464844,452],[129.9171142578125,452],[119.69227600097656,452],[109.46743774414062,452],[99.24259948730469,452],[89.01776123046875,452],[78.79292297363281,452],[68.56808471679688,452],[58.34324645996094,452],[48.118408203125,452],[37.8934326171875,452],[27.668594360351562,452],[20.0000187715832,449.4437561035156],[20.000018324641132,439.2189178466797],[20.000017877699065,428.99407958984375],[20.000017430756998,418.7692413330078],[20.00001698381493,408.5444030761719],[20.000016536873886,398.31956481933594],[20.00001608993182,388.0947265625],[20.00001564298975,377.86988830566406],[20.000015196041545,367.64491271972656],[20.000014749099478,357.4200744628906],[20.000014302158434,347.1952362060547],[20.000013855216366,336.97039794921875],[20.0000134082743,326.7455596923828],[20.00001296133223,316.5207214355469],[20.000012514390164,306.29588317871094],[20.00001206744912,296.071044921875],[20.000011620507053,285.84620666503906],[20.000011173564985,275.6213684082031],[20.00001072661678,265.3963928222656],[20.00001027967471,255.1715545654297],[20.000009832733667,244.94671630859375],[20.0000093857916,234.7218780517578],[20.000008938849533,224.49703979492188],[20.000008491907465,214.27220153808594],[20.00000804496591,204.04736328125],[20.000007598023842,193.82252502441406],[20.000007151081775,183.59768676757812],[20.00000670414022,173.3728485107422],[20.000006257192013,163.1478729248047],[20.000005810250457,152.92303466796875],[20.00000536330839,142.6981964111328],[20.000004916366834,132.47335815429688],[20.000004469424766,122.24851989746094],[20.000004022482955,112.023681640625],[20.000003575540887,101.79884338378906],[20.000003128599076,91.57400512695312],[20.000002681657264,81.34916687011719],[20.000002234715453,71.12432861328125],[20.000001787767502,60.89935302734375],[20.000001340825563,50.67451477050781],[20.00000089388375,40.449676513671875],[20.000000446941876,30.224838256835938]];

        // only use 400 boids for chips
        this.boidSystem.boids.forEach((boid, i) => {
            if (i < 200 || i >= 600) {
                // move from og pos 
                boid.storyTarget!.set(0, 30, 0);
            }
            else {
                // show chip
                const targetX = (chip_coord[i-200][0] - 250) * 0.75; // center the shape and scale
                const targetY = (300 - chip_coord[i-200][1]) * 0.75 + 300; // flip the y axis and scale
                const targetZ = 0;
                boid.storyTarget = new Vector3();
                // go to position
                boid.storyTarget!.set(targetX, targetY, targetZ);
            }
        });
    }

    // ================================ SCENE 4 ================================
    private updateScene4_WhirlpoolSwarm(): void {   
        const center = new Vector3(0, 350, 0);
        const radius = 150;
        const angleStep = (2 * Math.PI) / this.boidSystem.boids.length;

        this.boidSystem.boids.forEach((boid, index) => {
            const angle = index * angleStep + (this.sceneTime * 0.5); // 添加时间因子实现旋转效果
            boid.storyTarget!.set(
                center.x + radius * Math.cos(angle),
                center.y + radius * Math.sin(angle),
                center.z
            );

            const progress = this.sceneTime / this.config.scene4_duration;

            boid.lightIntensity = Math.sin(progress * Math.PI * 4 + (index / this.boidSystem.boids.length) * Math.PI * 2) * 0.5 + 0.5;
        });
    }
}
