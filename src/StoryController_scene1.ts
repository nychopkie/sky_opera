import { Boid } from './Boid';
import { BoidSystem } from './BoidSystem';
import { Vector3, Color } from 'three';
// import { BoidConfig } from './BoidConfig';

// 可复用的故事配置接口
export interface StoryConfig {
    totalBoidCount: number;
    initialBoidCount: number;
    // 定义最终分成的组及其比例和颜色
    groups: { ratio: number; color: Color }[];
    // 场景参数
    scene1_duration: number;
    scene2_duration: number;
    scene3_duration: number;
    scene4_duration: number;
}

// type StoryScene = 'inactive' | 'scene1_spiral' | 'scene2_expand' | 'scene3_split';
// type StoryScene = 'inactive' | 'scene1_split' | 'scene2_join' | 'scene3_expand' | 'scene4_shapes' | 'scene5_split';
type StoryScene = 'inactive' | 'scene0_initPos' |'scene1_scattered' | 'scene2_formOutline' | 'scene3_expand' | 'scene4_factory' ;

/**
 * 这是一个用于控制无人机群表演特定故事的控制器。
 * 它的设计是可复用的，只需提供不同的 `StoryConfig` 即可实现不同的故事。
 *
 * 实现原理：
 * 1. 状态机：内部通过一个简单的状态机 (`currentScene`) 来管理故事的三个阶段。
 * 2. 时间驱动：每个场景都有一个持续时间 (`sceneTime`)，当时间到达后会自动切换到下一个场景。
 * 3. 目标驱动：在每个场景中，控制器会为每个无人机计算一个特定的 `storyTarget`（目标位置）。
 *    - Boid 类本身的行为被修改为：当 `storyTarget` 存在时，它会产生一个强烈的、朝向该目标的力。
 *      这使得我们可以精确地控制无人机形成各种队形（螺旋、花朵、分组等），同时保留一些基础的群体行为。
 * 4. 视觉控制：控制器会直接修改 Boid 的 `isVisible` 和 `lightIntensity` 属性，
 *    这些属性随后被 `Scene.ts` 中的渲染器用来控制无人机的显示效果（是否可见、灯光亮度）。
 * 5. 配置化：所有的关键参数（如无人机数量、半径、高度、颜色等）都被提取到 `StoryConfig` 中，
 *    使得用户可以轻松地调整这些参数来复用此故事模板，讲述一个不同的、但结构相似的故事。
 */
export class StoryController {
    private boidSystem: BoidSystem;
    private config: StoryConfig;
    private currentScene: StoryScene = 'inactive';
    private sceneTime: number = 0;
    private initialBoids: Boid[] = [];
    private backgroundBoids: Boid[] = [];
    // Groups organized for scene1 (array of arrays of Boids)
    private groups: Boid[][] = [];

    constructor(boidSystem: BoidSystem, config: StoryConfig) {
        this.boidSystem = boidSystem;
        this.config = config;
    }

    public start(): void {
        this.boidSystem.initializeBoids(this.config.totalBoidCount);
        this.boidSystem.boids.forEach((b, index) => {
            b.position.set(0, 0, 0);
            b.velocity.set(0, 0, 0);

            if (index < this.config.initialBoidCount) {
                this.initialBoids.push(b);
                b.isVisible = false;
                b.lightIntensity = 1.0; // 初始组直接点亮
            } else {
                this.backgroundBoids.push(b);
                b.isVisible = false; // 先设置为可见，但灯光为0，在黑暗中不可见
                b.lightIntensity = 0.0;
            }
            b.storyTarget = new Vector3(); // 为每个boid初始化storyTarget
        });

        // set initial scene
        this.currentScene = 'scene0_initPos';
        this.sceneTime = 0;
    }

    public stop(): void {
        this.currentScene = 'inactive';
        this.boidSystem.boids.forEach(b => {
            b.storyTarget = null;
            b.lightIntensity = 0.0; // close all light when end
        });
        this.initialBoids = [];
        this.backgroundBoids = [];
    }

    public update(deltaTime: number): void {
        if (this.currentScene === 'inactive') return;

        this.sceneTime += deltaTime;

        switch (this.currentScene) {
            case 'scene0_initPos':
                this.updateScene0_InitPos();
                if (this.sceneTime >= 5.0) { // wait for 5 seconds
                    this.currentScene = 'scene1_scattered';
                    this.sceneTime = 0;
                }
                break;
            case 'scene1_scattered':
                this.updateScene1_Scattered();
                if (this.sceneTime >= this.config.scene1_duration) {
                    this.currentScene = 'scene2_formOutline';
                    this.sceneTime = 0;
                }
                break;
            case 'scene2_formOutline':
                this.updateScene2_FormOutline();
                if (this.sceneTime >= this.config.scene2_duration) {
                    this.currentScene = 'scene3_expand';
                    this.sceneTime = 0;
                }
                break;
            case 'scene3_expand':
                this.updateScene3_Expand();
                if (this.sceneTime >= this.config.scene3_duration) {
                    this.currentScene = 'scene4_factory';
                    this.sceneTime = 0;
                }
                break;
            case 'scene4_factory':
                this.updateScene4_Factory();
                if (this.sceneTime >= this.config.scene4_duration) {
                    this.stop(); // 故事结束
                }
                break;
        }
    }
    
    // here start the scene update methods
    // ================================ SCENE 0 ================================
    private updateScene0_InitPos(): void {
        // In this scene, boids fly to initial position from 0,0,0
        this.boidSystem.boids.forEach((boid) => {
            const targetX = Math.random() * 200 * Math.sign(Math.random() - 0.5);
            const targetY = Math.random() * 200 + 300; // Keep them above ground
            const targetZ = Math.random() * 200 * Math.sign(Math.random() - 0.5);
            // move slowly to scattered position from previous position according to progress
            boid.storyTarget!.set(targetX, targetY, targetZ);
        });
    }

    // ================================ SCENE 1 ================================
    // boids in a scattered position, not doing swarm behaviors yet
    // also pulse with breathing light >> sin function period
    private updateScene1_Scattered(): void {
        // scatter for all boids
        this.boidSystem.boids.forEach((boid, i) => {
            const progress = this.sceneTime / this.config.scene1_duration

            // change the visibility according to progress
            if (progress > 0.1) {
                // only show initial boids
                if (i < this.config.initialBoidCount) {
                    boid.isVisible = true;
                } else {
                    boid.isVisible = false;
                }
                // boid.velocity.set(0, 0, 0);
                boid.storyTarget = null;
            }

            // the light of the boids have a breathing effect (periodic change)
            // the light should range from 0 to 1 periodically
            boid.lightIntensity = Math.sin(progress * Math.PI * this.config.scene1_duration/5 + 3* Math.PI/2 * i/this.boidSystem.boids.length) * 0.5 + 0.5; // fade in effect
        });
    }

    // ================================ SCENE 2 ================================
    // form 
    private updateScene2_FormOutline(): void {
        // to stop motions >> set the velocity to 0 after arriving at target
        // form shape of shenzheng
        // form outline using the initialBoids only, others stay invisible aka intensity 0
        const progress = this.sceneTime / this.config.scene2_duration;
        const shengzhenOutlinePoints: any[][] = [[291.6099853515625,199.77000427246094],[279.1422424316406,206.9499969482422],[268.3073425292969,211.7833251953125],[266.7960662841797,226.91766357421875],[254.53375244140625,235.1250457763672],[244.13731384277344,244.95159912109375],[241.10012817382812,259.3440246582031],[229.17044067382812,268.77879333496094],[227.21897888183594,280.8716125488281],[230.09063720703125,295.5568542480469],[232.3098907470703,309.7661437988281],[242.69618225097656,320.4302673339844],[250.26153564453125,333.6248779296875],[257.8211212158203,346.8221130371094],[262.7992401123047,361.1939697265625],[267.77735900878906,375.56585693359375],[273.0955810546875,389.4599914550781],[285.2738342285156,385.0487976074219],[293.42279052734375,384.38690185546875],[287.8725280761719,395.5179748535156],[280.91656494140625,408.575439453125],[288.2861328125,421.88037109375],[295.65570068359375,435.1853332519531],[307.68548583984375,428.4230651855469],[318.2759704589844,417.50640869140625],[325.82000732421875,405.3548278808594],[330.6238708496094,394.8545227050781],[345.8304443359375,394.55224609375],[359.0240478515625,392.3977355957031],[370.9831848144531,401.795166015625],[385.1807556152344,401.11077880859375],[399.55859375,397.0064697265625],[408.42803955078125,384.65069580078125],[421.7940368652344,383.4935302734375],[434.9790954589844,376.0857849121094],[449.2621765136719,374.236572265625],[464.3241271972656,376.3507385253906],[476.7661437988281,367.6337890625],[489.1965637207031,358.8692932128906],[503.7261047363281,354.609130859375],[517.6719665527344,348.9974670410156],[530.4775085449219,340.7907409667969],[544.5081176757812,341.126953125],[559.10400390625,345.40411376953125],[565.599365234375,357.70196533203125],[574.7705688476562,368.9900817871094],[586.6671142578125,378.4666442871094],[587.760986328125,391.9377746582031],[585.969482421875,406.9317932128906],[587.2332153320312,422.0888671875],[598.59912109375,431.6317138671875],[611.9859619140625,432.472412109375],[623.9000244140625,423.33843994140625],[635.1273803710938,413.0779724121094],[648.38037109375,406.470703125],[657.8800048828125,398.47283935546875],[651.4991455078125,386.0368347167969],[638.8587036132812,378.3495178222656],[624.3924560546875,373.9944763183594],[614.4378662109375,367.3349304199219],[601.5929565429688,365.6026916503906],[603.3441772460938,353.9254150390625],[617.3534545898438,349.5902099609375],[630.3651733398438,343.2554931640625],[641.6812744140625,333.0928649902344],[639.4699096679688,321.03912353515625],[625.1716918945312,321.3802185058594],[610.46533203125,322.7667541503906],[596.0720825195312,319.28521728515625],[585.8112182617188,308.65667724609375],[572.5451049804688,308.2464599609375],[565.3157348632812,296.7961120605469],[567.8108520507812,284.2352294921875],[556.7186279296875,275.0676727294922],[555.681640625,262.4438781738281],[556.1240234375,249.70858764648438],[542.6738891601562,246.44676208496094],[528.2128601074219,243.71742248535156],[520.1582946777344,232.59556579589844],[513.3179321289062,221.8592529296875],[499.24017333984375,222.36859130859375],[488.01715087890625,232.63385009765625],[476.79412841796875,242.89910888671875],[465.1734619140625,237.23272705078125],[451.0884094238281,237.28195190429688],[445.169189453125,249.10879516601562],[448.4460754394531,263.7950134277344],[441.872314453125,277.5106201171875],[431.21722412109375,287.1265563964844],[417.6337890625,283.08782958984375],[406.4124450683594,272.82073974609375],[394.70880126953125,263.28919982910156],[380.8196716308594,257.0901641845703],[366.30780029296875,254.17770385742188],[351.6316833496094,252.7517852783203],[340.9599304199219,243.265625],[337.40234375,228.4779510498047],[327.19964599609375,218.4437713623047],[317.61651611328125,207.89833068847656],[306.7384948730469,201.3384246826172]];
        this.initialBoids.forEach((boid, i) => {
            // outline of shenzheng coordinates (simplified)
            const targetX = (shengzhenOutlinePoints[i][0] - 400) * 1.5; // center the shape and scale
            const targetY = (500 - shengzhenOutlinePoints[i][1]) * 1.5 + 200; // flip the y axis and scale
            const targetZ = 0;
            boid.storyTarget = new Vector3();
            // go to position
            boid.storyTarget!.set(targetX, targetY, targetZ);
            boid.isVisible = true;
            // slowly increase light intensity from current to 1.0
            boid.lightIntensity = Math.min(1.0, boid.lightIntensity + progress * 0.1);
        });

        // background boids remain invisible
        this.backgroundBoids.forEach((boid) => {
            boid.isVisible = false;
            boid.lightIntensity = 0.0;
            boid.storyTarget = new Vector3();
            // move to shekou
            boid.storyTarget!.set(
                20 - 200 * 0.8, 
                200 - 100 * 0.8 + 200, 
                0);
        });
    }

    // ================================ SCENE 3 ================================
    // shekou expand shere with increasing pulsing light
    private updateScene3_Expand(): void {
        // background boids expand outward in a sphere
        const progress = this.sceneTime / this.config.scene3_duration;
        const radius = 400 * progress;
        this.backgroundBoids.forEach((boid, i) => {
            boid.isVisible = true;
            const phi = Math.acos(-1 + (2 * i) / this.config.totalBoidCount);
            const theta = Math.sqrt(this.config.totalBoidCount * Math.PI) * phi;

            // expand at their current position
            boid.storyTarget!.set(
                radius * Math.cos(theta) * Math.sin(phi) + 20 - 200 * 0.8,
                10 + radius * Math.sin(theta) * Math.sin(phi) + 200 - 100 * 0.8 + 200,
                0
            );

            // increase light increase in a sinusoidal manner with period getting shorter
            boid.lightIntensity = Math.sin(progress * Math.PI * 10 * 5 * progress + 3* Math.PI/2 * i/this.boidSystem.boids.length) * 0.5 + 0.5; // fade in effect
        });
    }

    // ================================ SCENE 4 ================================
    // should be factory, but i put square as placeholder for now
    private updateScene4_Factory(): void {
        // all boids move to form a square factory shape
        const factory_coor: any[][] = [[372,36],[368.279541015625,36.0000057220459],[364.5591125488281,36.0000057220459],[360.83868408203125,36.000003814697266],[357.11822509765625,36.000003814697266],[353.3977966308594,36.000003814697266],[349.6773376464844,36.000003814697266],[345.9569091796875,36.000003814697266],[342.2364501953125,36.000003814697266],[338.5160217285156,36.00000190734863],[334.7955627441406,36.00000190734863],[331.07513427734375,36.00000190734863],[327.35467529296875,36.00000190734863],[323.6342468261719,36.00000190734863],[319.9137878417969,36.00000190734863],[316.193359375,36],[312.472900390625,36],[308.7524719238281,36],[305.0487365722656,36.271677017211914],[301.5041198730469,37.37359619140625],[298.31085205078125,39.26632308959961],[295.6376647949219,41.84197235107422],[293.626953125,44.96231269836426],[292.3923645019531,48.46290969848633],[292,52.154319763183594],[292,55.87476348876953],[292,59.59520721435547],[292,63.315650939941406],[292,67.03609466552734],[292,70.75653839111328],[292,74.47698211669922],[292,78.19742584228516],[292,81.91786193847656],[292,85.6383056640625],[292,89.35874938964844],[292,93.07919311523438],[292,96.79963684082031],[292,100.52008056640625],[292,104.24052429199219],[292,107.96096801757812],[292,111.68141174316406],[292,115.40185546875],[292,119.12229919433594],[292,122.84274291992188],[292,126.56318664550781],[292,130.2836151123047],[292,134.00405883789062],[292,137.72450256347656],[292,141.4449462890625],[292,145.16539001464844],[292,148.88583374023438],[292,152.6062774658203],[292,156.32672119140625],[292,160.0471649169922],[292,163.76760864257812],[288.511962890625,164],[284.79150390625,164],[281.071044921875,164],[277.3506164550781,164],[273.6301727294922,164],[269.90972900390625,164],[266.1892852783203,164],[262.4688415527344,164],[260,162.74839782714844],[260,159.0279541015625],[260,155.30751037597656],[260,151.58706665039062],[260,147.8666229248047],[260,144.14617919921875],[260,140.42572021484375],[260,136.70529174804688],[260,132.98483276367188],[259.76817321777344,129.27760314941406],[258.7179870605469,125.7172622680664],[256.8759002685547,122.49449920654297],[254.3407745361328,119.78301239013672],[251.2489013671875,117.72880554199219],[247.7670135498047,116.44221496582031],[244.08226013183594,115.9927978515625],[240.39309692382812,116.4041976928711],[236.89820861816406,117.65515899658203],[233.57058715820312,119.31906127929688],[230.24305725097656,120.98319244384766],[226.91555786132812,122.64730834960938],[223.5880126953125,124.31144714355469],[220.26051330566406,125.9755630493164],[216.9329833984375,127.63969421386719],[213.60546875,129.3038101196289],[210.27793884277344,130.9679412841797],[206.950439453125,132.63206481933594],[203.6229248046875,134.29618072509766],[200.29539489746094,135.96031188964844],[196.9678955078125,137.6244354248047],[193.64035034179688,139.28856658935547],[190.31285095214844,140.9526824951172],[186.98532104492188,142.61681365966797],[183.65780639648438,144.28093719482422],[180.3302764892578,145.945068359375],[177.00277709960938,147.60918426513672],[173.67523193359375,149.2733154296875],[170.3477325439453,150.93743896484375],[167.02020263671875,152.6015625],[164,153.76840209960938],[164,150.04794311523438],[164,146.3275146484375],[164,142.6070556640625],[164,138.88662719726562],[164,135.16616821289062],[163.99058532714844,131.44585418701172],[163.4345245361328,127.77574157714844],[162.04718017578125,124.33267211914062],[159.9042205810547,121.30166625976562],[157.12017822265625,118.84644317626953],[153.84552001953125,117.09839630126953],[150.2560577392578,116.15241241455078],[146.54519653320312,116.05878448486328],[142.91262817382812,116.82273864746094],[139.5214614868164,118.34327697753906],[136.19378662109375,120.00711059570312],[132.8661346435547,121.67094421386719],[129.5384521484375,123.33477783203125],[126.21080017089844,124.99860382080078],[122.88311767578125,126.66244506835938],[119.55546569824219,128.3262710571289],[116.227783203125,129.9901123046875],[112.90013122558594,131.6539306640625],[109.57247924804688,133.31776428222656],[106.24479675292969,134.98159790039062],[102.91714477539062,136.64542388916016],[99.58946990966797,138.30926513671875],[96.2618179321289,139.97309112548828],[92.93413543701172,141.63693237304688],[89.60648345947266,143.3007583618164],[86.27880859375,144.964599609375],[82.95115280151367,146.62841796875],[79.62347030639648,148.29226684570312],[76.29581832885742,149.95608520507812],[72.9681396484375,151.61993408203125],[69.64045715332031,153.2837677001953],[66.31283569335938,154.94757080078125],[62.98515319824219,156.61141967773438],[59.657474517822266,158.27525329589844],[56.329795837402344,159.93910217285156],[53.002166748046875,161.6029052734375],[49.67448806762695,163.26675415039062],[46.34680938720703,164.9305877685547],[43.08206558227539,166.7078857421875],[40.26087760925293,169.1204071044922],[38.07174301147461,172.11830139160156],[36.63161849975586,175.53964233398438],[36.01954650878906,179.20077514648438],[36.00000762939453,182.92095947265625],[36.00000762939453,186.64141845703125],[36.00000762939453,190.36187744140625],[36.00000762939453,194.082275390625],[36.00000762939453,197.802734375],[36.00000762939453,201.523193359375],[36.00000762939453,205.24365234375],[36.00000762939453,208.96405029296875],[36.00000762939453,212.68450927734375],[36.00000762939453,216.40496826171875],[36.0000057220459,220.1253662109375],[36.0000057220459,223.8458251953125],[36.0000057220459,227.5662841796875],[36.0000057220459,231.2867431640625],[36.0000057220459,235.00714111328125],[36.0000057220459,238.72760009765625],[36.0000057220459,242.44805908203125],[36.0000057220459,246.16851806640625],[36.0000057220459,249.888916015625],[36.0000057220459,253.609375],[36.0000057220459,257.329833984375],[36.0000057220459,261.05029296875],[36.000003814697266,264.77069091796875],[36.000003814697266,268.49114990234375],[36.000003814697266,272.21160888671875],[36.000003814697266,275.93206787109375],[36.000003814697266,279.6524658203125],[36.000003814697266,283.3729248046875],[36.000003814697266,287.0933837890625],[36.000003814697266,290.81378173828125],[36.000003814697266,294.53424072265625],[36.000003814697266,298.25469970703125],[36.000003814697266,301.97515869140625],[36.000003814697266,305.695556640625],[36.00000190734863,309.416015625],[36.00000190734863,313.136474609375],[36.00000190734863,316.85693359375],[36.00000190734863,320.57733154296875],[36.00000190734863,324.29779052734375],[36.00000190734863,328.01824951171875],[36.00000190734863,331.73870849609375],[36.00000190734863,335.4591064453125],[36.00000190734863,339.1795654296875],[36.00000190734863,342.9000244140625],[36.00000190734863,346.6204833984375],[36,350.34088134765625],[36,354.06134033203125],[36,357.78179931640625],[36,361.502197265625],[36,365.22265625],[36,368.943115234375],[36.01358604431152,372.6634216308594],[36.59284973144531,376.3298645019531],[38.005821228027344,379.76239013671875],[40.17305946350098,382.7761535644531],[42.97371292114258,385.21270751953125],[46.25960922241211,386.9393310546875],[49.85619926452637,387.8575744628906],[53.57037353515625,388],[57.29083251953125,388],[61.01123046875,388],[64.731689453125,388],[68.4521484375,388],[72.172607421875,388],[75.89300537109375,388],[79.61346435546875,388],[83.33392333984375,388],[87.0543212890625,388],[90.7747802734375,388],[94.4952392578125,388],[98.2156982421875,388],[101.93609619140625,388],[105.65655517578125,388],[109.37701416015625,388],[113.09747314453125,388],[116.81787109375,388],[120.538330078125,388],[124.2587890625,388],[127.979248046875,388],[131.69964599609375,388],[135.42010498046875,388],[139.14056396484375,388],[142.8609619140625,388],[146.5814208984375,388],[150.3018798828125,388],[154.0223388671875,388],[157.74273681640625,388],[161.46319580078125,388],[165.18365478515625,388],[168.90411376953125,388],[172.62451171875,388],[176.344970703125,388],[180.0654296875,388],[183.785888671875,388],[187.50628662109375,388],[191.22674560546875,388],[194.94720458984375,388],[198.66766357421875,388],[202.3880615234375,388],[206.1085205078125,388],[209.8289794921875,388],[213.54937744140625,388],[217.26983642578125,388],[220.99029541015625,388],[224.71075439453125,388],[228.43115234375,388],[232.151611328125,388],[235.8720703125,388],[239.592529296875,388],[243.31292724609375,388],[247.03338623046875,388],[250.75384521484375,388],[254.47430419921875,388],[258.1947021484375,388],[261.9151611328125,388],[265.6356201171875,388],[269.3560791015625,388],[273.07647705078125,388],[276.79693603515625,388],[280.51739501953125,388],[284.23779296875,388],[287.958251953125,388],[291.6787109375,388],[295.399169921875,388],[299.11956787109375,388],[302.840087890625,388],[306.5604248046875,388],[310.2808837890625,388],[314.0013427734375,388],[317.7218017578125,388],[321.4422607421875,388],[325.1627197265625,388],[328.8831787109375,388],[332.6036376953125,388],[336.323974609375,388],[340.04443359375,388],[343.764892578125,388],[347.4853515625,388],[351.205810546875,388],[354.92626953125,388],[358.646728515625,388],[362.3670654296875,388],[366.0875244140625,388],[369.8079833984375,388],[373.52618408203125,387.9280700683594],[377.15582275390625,387.1509704589844],[380.506591796875,385.5535583496094],[383.39923095703125,383.2272033691406],[385.68170166015625,380.29974365234375],[387.2275695800781,376.9251708984375],[387.9491271972656,373.2839660644531],[388,369.5648193359375],[388,365.8443603515625],[388,362.1239013671875],[388,358.4034423828125],[388,354.6829833984375],[388,350.962646484375],[388,347.2421875],[388,343.521728515625],[388,339.80126953125],[388,336.080810546875],[388,332.3603515625],[388,328.639892578125],[388,324.91943359375],[388,321.1990966796875],[388,317.4786376953125],[388,313.7581787109375],[388,310.0377197265625],[388,306.3172607421875],[388,302.5968017578125],[388,298.8763427734375],[388,295.156005859375],[388,291.435546875],[388,287.715087890625],[388,283.99462890625],[388,280.274169921875],[388,276.5537109375],[388,272.833251953125],[388,269.11279296875],[388,265.3924560546875],[388,261.6719970703125],[388,257.9515380859375],[388,254.2310791015625],[388,250.5106201171875],[388,246.7901611328125],[388,243.0697021484375],[388,239.3492431640625],[388,235.62890625],[388,231.908447265625],[388,228.18798828125],[388,224.467529296875],[388,220.7470703125],[388,217.026611328125],[388,213.30615234375],[388,209.5858154296875],[388,205.8653564453125],[388,202.1448974609375],[388,198.4244384765625],[388,194.7039794921875],[388,190.9835205078125],[388,187.2630615234375],[388,183.5426025390625],[388,179.822265625],[388,176.101806640625],[388,172.38134765625],[388,168.660888671875],[388,164.9404296875],[388,161.219970703125],[388,157.49951171875],[388,153.7791748046875],[388,150.0587158203125],[388,146.3382568359375],[388,142.6177978515625],[388,138.8973388671875],[388,135.1768798828125],[388,131.4564208984375],[388,127.7359619140625],[388,124.015625],[388,120.295166015625],[388,116.57470703125],[388,112.854248046875],[388,109.1337890625],[388,105.413330078125],[388,101.69287109375],[388,97.9725341796875],[388,94.2520751953125],[388,90.5316162109375],[388,86.8111572265625],[388,83.0906982421875],[388,79.3702392578125],[388,75.6497802734375],[388,71.9293212890625],[388,68.208984375],[388,64.488525390625],[388,60.76806640625],[388,57.047607421875],[388,53.3271484375],[387.8233947753906,49.615394592285156],[386.850341796875,46.03332710266113],[385.07373046875,42.77408409118652],[382.59521484375,40.010576248168945],[379.5489501953125,37.889238357543945],[376.0953063964844,36.528921127319336],[372.4202880859375,36.00543403625488],[356,71.300048828125],[356,75.0205078125],[356,78.740966796875],[356,82.4613037109375],[356,86.1817626953125],[356,89.9022216796875],[356,93.6226806640625],[356,97.3431396484375],[354.9364013671875,100],[351.2159423828125,100],[347.4954833984375,100],[343.775146484375,100],[340.0546875,100],[336.334228515625,100],[332.61376953125,100],[328.893310546875,100],[325.1728515625,100],[324,97.452392578125],[324,93.7320556640625],[324,90.0115966796875],[324,86.2911376953125],[324,82.5706787109375],[324,78.8502197265625],[324,75.1297607421875],[324,71.4093017578125],[324.3111572265625,68],[328.031494140625,68],[331.751953125,68],[335.472412109375,68],[339.19287109375,68],[342.913330078125,68],[346.6337890625,68],[350.354248046875,68],[354.07470703125,68],[68.00000762939453,354.20501708984375],[68.00000762939453,350.48455810546875],[68.00000762939453,346.76409912109375],[68.00000762939453,343.04364013671875],[68.00000762939453,339.32318115234375],[68.00000762939453,335.60272216796875],[68.00000762939453,331.88226318359375],[68.00000762939453,328.16192626953125],[68.00000762939453,324.44146728515625],[68.00000381469727,320.72100830078125],[68.00000381469727,317.00054931640625],[68.00000381469727,313.28009033203125],[68.00000381469727,309.55963134765625],[68.00000381469727,305.83917236328125],[68.00000381469727,302.11871337890625],[68.00000381469727,298.39837646484375],[68.00000381469727,294.67791748046875],[68.00000381469727,290.95745849609375],[68.00000381469727,287.23699951171875],[68.00000381469727,283.51654052734375],[68.00000381469727,279.79608154296875],[68.00000381469727,276.07562255859375],[68.00000381469727,272.35528564453125],[68.00000381469727,268.63482666015625],[68.00000381469727,264.91436767578125],[68.00000381469727,261.19390869140625],[68.00000381469727,257.47344970703125],[68.00000381469727,253.75299072265625],[68.00000381469727,250.03253173828125],[68.00000381469727,246.31207275390625],[68.00000381469727,242.59173583984375],[68.00000381469727,238.87127685546875],[68.00000381469727,235.15081787109375],[68,231.43035888671875],[68,227.70989990234375],[68,223.98944091796875],[68,220.26898193359375],[68,216.54864501953125],[68,212.82818603515625],[68,209.10772705078125],[68,205.38726806640625],[68,201.66680908203125],[68,197.94635009765625],[68,194.22589111328125],[68,190.50543212890625],[70.77530288696289,188.50035095214844],[74.10298156738281,186.83651733398438],[77.43066024780273,185.17266845703125],[80.75834274291992,183.5088348388672],[84.08602142333984,181.84498596191406],[87.4136962890625,180.18115234375],[90.74137878417969,178.51730346679688],[94.06906127929688,176.8534698486328],[97.3966293334961,175.18968200683594],[100.72431182861328,173.52584838867188],[104.05198669433594,171.86199951171875],[107.37966918945312,170.1981658935547],[110.70735168457031,168.53433227539062],[114.03502655029297,166.8704833984375],[117.36270904541016,165.20664978027344],[120.69027709960938,163.54286193847656],[124.01795959472656,161.8790283203125],[127.34563446044922,160.21517944335938],[130.6733169555664,158.5513458251953],[132,160.1251220703125],[132,163.8455810546875],[132,167.5660400390625],[132,171.2864990234375],[132,175.0068359375],[132,178.727294921875],[132.18546295166016,182.4383544921875],[133.1714859008789,186.01705932617188],[134.95536041259766,189.27236938476562],[137.4412612915039,192.02906799316406],[140.49575805664062,194.1385498046875],[143.9537582397461,195.487548828125],[147.62993621826172,196.0031280517578],[151.32594299316406,195.6581573486328],[154.8426971435547,194.47032165527344],[158.17202758789062,192.80966186523438],[161.4995574951172,191.14553833007812],[164.82708740234375,189.4813995361328],[168.1546173095703,187.81727600097656],[171.4820556640625,186.1531982421875],[174.80958557128906,184.4890594482422],[178.13711547851562,182.82492065429688],[181.4646453857422,181.16079711914062],[184.79217529296875,179.4966583251953],[188.11972045898438,177.83253479003906],[191.44725036621094,176.16839599609375],[194.77467346191406,174.5043182373047],[198.10220336914062,172.84017944335938],[201.4297332763672,171.17605590820312],[204.75726318359375,169.5119171142578],[208.08480834960938,167.84779357910156],[211.41233825683594,166.18365478515625],[214.7398681640625,164.51951599121094],[218.06739807128906,162.8553924560547],[221.3948211669922,161.19131469726562],[224.7223663330078,159.5271759033203],[228,157.94384765625],[228,161.664306640625],[228,165.384765625],[228,169.105224609375],[228,172.82568359375],[228,176.546142578125],[228.0022430419922,180.26651000976562],[228.4904327392578,183.94635009765625],[229.81727600097656,187.41294860839844],[231.9092254638672,190.4794921875],[234.64889526367188,192.98435974121094],[237.8909149169922,194.79226684570312],[241.46343994140625,195.800048828125],[245.17333984375,196],[248.893798828125,196],[252.6142578125,196],[256.334716796875,196],[260.05517578125,196],[263.775634765625,196],[267.49609375,196],[271.216552734375,196],[274.9368896484375,196],[278.657470703125,196],[282.3779296875,196],[286.098388671875,196],[289.818603515625,196],[293.5390625,196],[297.259521484375,196],[300.97998046875,196],[304.700439453125,196],[308.4208679199219,195.9945526123047],[312.09576416015625,195.470947265625],[315.5494384765625,194.11048889160156],[318.59564208984375,191.98904418945312],[321.07403564453125,189.2254638671875],[322.8505859375,185.96609497070312],[323.8235168457031,182.38381958007812],[324,178.672119140625],[324,174.95166015625],[324,171.231201171875],[324,167.510986328125],[324,163.79052734375],[324,160.070068359375],[324,156.349609375],[324,152.629150390625],[324,148.90869140625],[324,145.188232421875],[324,141.4677734375],[324,137.747314453125],[324,134.02685546875],[325.693603515625,132],[329.4140625,132],[333.134521484375,132],[336.85498046875,132],[340.575439453125,132],[344.295654296875,132],[348.01611328125,132],[351.736572265625,132],[355.45703125,132],[356,135.177490234375],[356,138.89794921875],[356,142.618408203125],[356,146.3388671875],[356,150.059326171875],[356,153.77978515625],[356,157.500244140625],[356,161.220703125],[356,164.941162109375],[356,168.66162109375],[356,172.382080078125],[356,176.102294921875],[356,179.82275390625],[356,183.543212890625],[356,187.263671875],[356,190.984130859375],[356,194.70458984375],[356,198.425048828125],[356,202.1455078125],[356,205.865966796875],[356,209.58642578125],[356,213.306884765625],[356,217.02734375],[356,220.747802734375],[356,224.46826171875],[356,228.188720703125],[356,231.908935546875],[356,235.62939453125],[356,239.349853515625],[356,243.0703125],[356,246.790771484375],[356,250.51123046875],[356,254.231689453125],[356,257.9521484375],[356,261.672607421875],[356,265.39306640625],[356,269.113525390625],[356,272.833984375],[356,276.554443359375],[356,280.27490234375],[356,283.995361328125],[356,287.715576171875],[356,291.43603515625],[356,295.156494140625],[356,298.876953125],[356,302.597412109375],[356,306.31787109375],[356,310.038330078125],[356,313.7587890625],[356,317.479248046875],[356,321.19970703125],[356,324.920166015625],[356,328.640625],[356,332.361083984375],[356,336.08154296875],[356,339.802001953125],[356,343.522216796875],[356,347.24267578125],[356,350.963134765625],[356,354.68359375],[353.595947265625,356.0000305175781],[349.87548828125,356.0000305175781],[346.155029296875,356.0000305175781],[342.4345703125,356.0000305175781],[338.714111328125,356.0000305175781],[334.99365234375,356.0000305175781],[331.273193359375,356.0000305175781],[327.552734375,356.0000305175781],[323.832275390625,356.0000305175781],[320.11181640625,356.0000305175781],[316.391357421875,356.0000305175781],[312.6708984375,356.0000305175781],[308.95068359375,356.0000305175781],[305.230224609375,356.0000305175781],[301.509765625,356.0000305175781],[297.789306640625,356.0000305175781],[294.06884765625,356.0000305175781],[290.348388671875,356.0000305175781],[286.6279296875,356.0000305175781],[282.907470703125,356.0000305175781],[279.18701171875,356.0000305175781],[275.466552734375,356.0000305175781],[271.74609375,356.0000305175781],[268.025634765625,356.0000305175781],[264.30517578125,356.0000305175781],[260.584716796875,356.0000305175781],[256.8642578125,356.0000305175781],[253.14404296875,356.0000305175781],[249.423583984375,356.0000305175781],[245.703125,356.0000305175781],[241.982666015625,356],[238.26220703125,356],[234.541748046875,356],[230.8212890625,356],[227.100830078125,356],[223.38037109375,356],[219.659912109375,356],[215.939453125,356],[212.218994140625,356],[208.49853515625,356],[204.778076171875,356],[201.0576171875,356],[197.33740234375,356],[193.616943359375,356],[189.896484375,356],[186.176025390625,356],[182.45556640625,356],[178.735107421875,356],[175.0146484375,356],[171.294189453125,356],[167.57373046875,356],[163.853271484375,356],[160.1328125,356],[156.412353515625,356],[152.69189453125,356],[148.971435546875,356],[145.2509765625,356],[141.53076171875,356],[137.810302734375,356],[134.08984375,356],[130.369384765625,356],[126.64892578125,356],[122.928466796875,356],[119.2080078125,356],[115.487548828125,356],[111.76708984375,356],[108.046630859375,356],[104.326171875,356],[100.605712890625,356],[96.88525390625,356],[93.164794921875,356],[89.4443359375,356],[85.72412109375,356],[82.003662109375,356],[78.283203125,356],[74.562744140625,356],[70.84228515625,356],[100.878173828125,228],[104.5986328125,228],[108.319091796875,228],[112.03955078125,228],[115.760009765625,228],[119.48046875,228],[123.200927734375,228],[126.92138671875,228],[130.641845703125,228],[134.3623046875,228],[138.08251953125,228],[141.802978515625,228],[145.5234375,228],[148,229.243896484375],[148,232.96435546875],[148,236.684814453125],[148,240.4052734375],[148,244.125732421875],[148,247.84619140625],[148,251.566650390625],[148,255.287109375],[148,259.007568359375],[145.27197265625,260],[141.551513671875,260],[137.8310546875,260],[134.11083984375,260],[130.390380859375,260],[126.669921875,260],[122.949462890625,260],[119.22900390625,260],[115.508544921875,260],[111.7880859375,260],[108.067626953125,260],[104.34716796875,260],[100.626708984375,260],[100,256.90625],[100,253.185791015625],[100,249.46533203125],[100,245.744873046875],[100,242.0244140625],[100,238.303955078125],[100,234.583740234375],[100,230.86328125],[180.857177734375,228],[184.57763671875,228],[188.298095703125,228],[192.0185546875,228],[195.739013671875,228],[199.45947265625,228],[203.179931640625,228],[206.900390625,228],[210.620849609375,228],[214.34130859375,228],[218.061767578125,228],[221.7822265625,228],[225.502685546875,228],[229.222900390625,228],[232.943359375,228],[236.663818359375,228],[240.38427734375,228],[244,228.104736328125],[244,231.8251953125],[244,235.545654296875],[244,239.26611328125],[244,242.986572265625],[244,246.70703125],[244,250.427490234375],[244,254.14794921875],[244,257.868408203125],[242.4111328125,260],[238.690673828125,260],[234.970458984375,260],[231.25,260],[227.529541015625,260],[223.80908203125,260],[220.088623046875,260],[216.3681640625,260],[212.647705078125,260],[208.92724609375,260],[205.206787109375,260],[201.486328125,260],[197.765869140625,260],[194.04541015625,260],[190.324951171875,260],[186.6044921875,260],[182.884033203125,260],[180,259.163818359375],[180,255.443359375],[180,251.722900390625],[180,248.00244140625],[180,244.281982421875],[180,240.5615234375],[180,236.841064453125],[180,233.12060546875],[180,229.400146484375],[278.3203125,228],[282.040771484375,228],[285.76123046875,228],[289.481689453125,228],[293.2021484375,228],[296.922607421875,228],[300.642822265625,228],[304.36328125,228],[308.083740234375,228],[311.80419921875,228],[315.524658203125,228],[319.2451171875,228],[322.965576171875,228],[324,230.68603515625],[324,234.406494140625],[324,238.126953125],[324,241.847412109375],[324,245.56787109375],[324,249.288330078125],[324,253.0087890625],[324,256.729248046875],[323.550537109375,260],[319.830078125,260],[316.109619140625,260],[312.38916015625,260],[308.668701171875,260],[304.9482421875,260],[301.227783203125,260],[297.50732421875,260],[293.786865234375,260],[290.06640625,260],[286.345947265625,260],[282.62548828125,260],[278.905029296875,260],[276,259.1845703125],[276,255.464111328125],[276,251.74365234375],[276,248.0234375],[276,244.302978515625],[276,240.58251953125],[276,236.862060546875],[276,233.1416015625],[276,229.421142578125],[102.29931640625,292],[106.019775390625,292],[109.740234375,292],[113.460693359375,292],[117.18115234375,292],[120.901611328125,292],[124.6220703125,292],[128.342529296875,292],[132.06298828125,292],[135.783203125,292],[139.503662109375,292],[143.22412109375,292],[146.944580078125,292],[148,294.6650390625],[148,298.385498046875],[148,302.10595703125],[148,305.826416015625],[148,309.546875],[148,313.267333984375],[148,316.98779296875],[148,320.708251953125],[147.5712890625,324],[143.850830078125,324],[140.13037109375,324],[136.41015625,324],[132.689697265625,324],[128.96923828125,324],[125.248779296875,324],[121.5283203125,324],[117.807861328125,324],[114.08740234375,324],[110.366943359375,324],[106.646484375,324],[102.926025390625,324],[100,323.20556640625],[100,319.485107421875],[100,315.7646484375],[100,312.044189453125],[100,308.32373046875],[100,304.603515625],[100,300.883056640625],[100,297.16259765625],[100,293.442138671875],[182.2783203125,292],[185.998779296875,292],[189.71923828125,292],[193.439697265625,292],[197.16015625,292],[200.880615234375,292],[204.60107421875,292],[208.321533203125,292],[212.0419921875,292],[215.762451171875,292],[219.48291015625,292],[223.203125,292],[226.923583984375,292],[230.64404296875,292],[234.364501953125,292],[238.0849609375,292],[241.805419921875,292],[244,293.52587890625],[244,297.246337890625],[244,300.966796875],[244,304.687255859375],[244,308.40771484375],[244,312.128173828125],[244,315.8486328125],[244,319.569091796875],[244,323.28955078125],[240.990234375,324],[237.269775390625,324],[233.54931640625,324],[229.828857421875,324],[226.1083984375,324],[222.387939453125,324],[218.66748046875,324],[214.947021484375,324],[211.2265625,324],[207.506103515625,324],[203.78564453125,324],[200.065185546875,324],[196.3447265625,324],[192.624267578125,324],[188.90380859375,324],[185.18359375,324],[181.463134765625,324],[180,321.74267578125],[180,318.022216796875],[180,314.3017578125],[180,310.581298828125],[180,306.86083984375],[180,303.140380859375],[180,299.419921875],[180,295.699462890625],[276.02099609375,292],[279.741455078125,292],[283.4619140625,292],[287.182373046875,292],[290.90283203125,292],[294.623291015625,292],[298.343505859375,292],[302.06396484375,292],[305.784423828125,292],[309.5048828125,292],[313.225341796875,292],[316.94580078125,292],[320.666259765625,292],[324,292.38671875],[324,296.107177734375],[324,299.82763671875],[324,303.548095703125],[324,307.2685546875],[324,310.989013671875],[324,314.70947265625],[324,318.429931640625],[324,322.150146484375],[322.12939453125,324],[318.408935546875,324],[314.6884765625,324],[310.968017578125,324],[307.24755859375,324],[303.527099609375,324],[299.806640625,324],[296.086181640625,324],[292.36572265625,324],[288.645263671875,324],[284.9248046875,324],[281.204345703125,324],[277.48388671875,324],[276,321.763427734375],[276,318.043212890625],[276,314.32275390625],[276,310.602294921875],[276,306.8818359375],[276,303.161376953125],[276,299.44091796875],[276,295.720458984375]];
        
        this.boidSystem.boids.forEach((boid, i) => {
            // show factory
            const targetX = (factory_coor[i][0] - 200) * 1.5; // center the shape and scale
            const targetY = (800 - factory_coor[i][1]) * 1.5 - 500; // flip the y axis and scale
            const targetZ = 0;
            boid.storyTarget = new Vector3();
            // go to position
            boid.storyTarget!.set(targetX, targetY, targetZ);
            boid.isVisible = true;
            // slowly increase light intensity from current to 1.0
            boid.lightIntensity = 1.0;
            
        });

    }


}