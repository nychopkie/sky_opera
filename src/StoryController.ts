import { getNadgrids } from 'proj4/dist/lib/nadgrid';
import { Boid } from './Boid';
import { BoidSystem } from './BoidSystem';
import { Vector3, Color } from 'three';

// 可复用的故事配置接口
export interface StoryConfig {
    totalBoidCount: number;
    initialBoidCount: number;
    // 定义最终分成的组及其比例和颜色
    groups: { ratio: number; color: Color }[];
    // 场景参数
    scene1_duration: number;
    scene2_duration: number;
    scene3_duration: number;
    scene4_duration: number;
}

type StoryScene = 'inactive' | 'scene0_idle' | 'scene0_split' | 'scene1_conv' | 'scene2_shape' | 'scene3_coolShape' | 'scene4_circle' ;

/**
 * 这是一个用于控制无人机群表演特定故事的控制器。
 * 它的设计是可复用的，只需提供不同的 `StoryConfig` 即可实现不同的故事。
 *
 * 实现原理：
 * 1. 状态机：内部通过一个简单的状态机 (`currentScene`) 来管理故事的三个阶段。
 * 2. 时间驱动：每个场景都有一个持续时间 (`sceneTime`)，当时间到达后会自动切换到下一个场景。
 * 3. 目标驱动：在每个场景中，控制器会为每个无人机计算一个特定的 `storyTarget`（目标位置）。
 *    - Boid 类本身的行为被修改为：当 `storyTarget` 存在时，它会产生一个强烈的、朝向该目标的力。
 *      这使得我们可以精确地控制无人机形成各种队形（螺旋、花朵、分组等），同时保留一些基础的群体行为。
 * 4. 视觉控制：控制器会直接修改 Boid 的 `isVisible` 和 `lightIntensity` 属性，
 *    这些属性随后被 `Scene.ts` 中的渲染器用来控制无人机的显示效果（是否可见、灯光亮度）。
 * 5. 配置化：所有的关键参数（如无人机数量、半径、高度、颜色等）都被提取到 `StoryConfig` 中，
 *    使得用户可以轻松地调整这些参数来复用此故事模板，讲述一个不同的、但结构相似的故事。
 */
export class StoryController {
    private boidSystem: BoidSystem;
    private config: StoryConfig;
    private currentScene: StoryScene = 'inactive';
    private sceneTime: number = 0;
    private initialBoids: Boid[] = [];
    private backgroundBoids: Boid[] = [];

    constructor(boidSystem: BoidSystem, config: StoryConfig) {
        this.boidSystem = boidSystem;
        this.config = config;
    }

    public start(): void {
        this.boidSystem.initializeBoids(this.config.totalBoidCount);
        this.boidSystem.boids.forEach((b, index) => {
            // 所有无人机从地面中心开始
            b.position.set(0, 0, 0);
            b.velocity.set(0, 0, 0);

            if (index < this.config.initialBoidCount) {
                this.initialBoids.push(b);
                b.isVisible = true;
                b.lightIntensity = 1.0; // 初始组直接点亮
            } else {
                this.backgroundBoids.push(b);
                b.isVisible = true; // 先设置为可见，但灯光为0，在黑暗中不可见
                b.lightIntensity = 1.0;
            }
            b.storyTarget = new Vector3(); // 为每个boid初始化storyTarget
        });

        this.currentScene = 'scene0_idle';
        this.sceneTime = 0;
    }

    public stop(): void {
        this.currentScene = 'inactive';
        this.boidSystem.boids.forEach(b => {
            b.storyTarget = null;
            b.lightIntensity = 1.0;
        });
        this.initialBoids = [];
        this.backgroundBoids = [];
    }

    public update(deltaTime: number): void {
        if (this.currentScene === 'inactive') return;

        this.sceneTime += deltaTime;

        switch (this.currentScene) {
            case 'scene0_idle':
                this.updateScene0_idle();
                if (this.sceneTime >= 5) {
                    this.currentScene = 'scene0_split';
                    this.assignGroupsForScene0();
                    this.sceneTime = 0;
                }
                break;
            case 'scene0_split':
                this.updateScene0_split();
                if (this.sceneTime >= 20) {
                    this.currentScene = 'scene1_conv';
                    this.sceneTime = 0;
                }
                break;
            case 'scene1_conv':
                this.updateScene1_conv();
                if (this.sceneTime >= this.config.scene1_duration) {
                    this.currentScene = 'scene2_shape';
                    this.sceneTime = 0;
                }
                break;
            case 'scene2_shape':
                this.updateScene2_shape();
                if (this.sceneTime >= this.config.scene2_duration) {
                    this.currentScene = 'scene3_coolShape';
                    this.sceneTime = 0;
                }
                break;
            case 'scene3_coolShape':
                this.updateScene3_coolShape();
                if (this.sceneTime >= this.config.scene3_duration) {
                    this.currentScene = 'scene4_circle';
                    this.sceneTime = 0;
                }
                break;
            case 'scene4_circle':
                this.updateScene4_circle();
                if (this.sceneTime >= this.config.scene4_duration) {
                    this.stop(); // 故事结束
                }
                break;
        }
    }
    
    // here start the scene update methods
    // ============================================================================
    private updateScene0_idle(): void {
        // set a small value for each boid as the target to keep them hovering in place
        this.boidSystem.boids.forEach(b => {
            b.storyTarget!.set(
                b.position.x + (Math.random() - 0.5) * 10,
                b.position.y + (Math.random() - 0.5) * 10,
                b.position.z + (Math.random() - 0.5) * 10
            );
        });
    }

    // split into groups according to the config, with initial boids in each group according to ratio
    private assignGroupsForScene0(): void {
        let boidIndex = 0;
        this.config.groups.forEach(group => {
            const groupSize = Math.floor(this.config.totalBoidCount * group.ratio);
            for (let i = 0; i < groupSize && boidIndex < this.config.totalBoidCount; i++) {
                const boid = this.boidSystem.boids[boidIndex];
                if (boid) {
                    boid.groupData = group; // 将分组信息附加到boid上
                    // Assign the group's color to the boid so it shows the correct color immediately
                    if (group.color) boid.color.set(group.color);
                }
                boidIndex++;
            }
        });

        // 将剩余的boids分配给最大的组
        const largestGroup = this.config.groups.reduce((a, b) => a.ratio > b.ratio ? a : b);
        for (; boidIndex < this.config.totalBoidCount; boidIndex++) {
            const b = this.boidSystem.boids[boidIndex];
            b.groupData = largestGroup;
            if (largestGroup.color) b.color.set(largestGroup.color);
        }

        // Ensure all boids' color properties reflect their assigned group
        this.applyGroupColors();
        // Also set global emissive color in the BoidConfig so the Scene material can pick it up
        try {
            if (largestGroup && largestGroup.color) {
                // store as hex number
                (this.boidSystem.config as any).emissiveColor = largestGroup.color.getHex();
                (this.boidSystem.config as any).emissiveIntensity = 1.0;
            }
        } catch (_) {}
    }

    /**
     * Apply group colors to all boids according to their `groupData`.
     * This centralizes the assignment so other code paths can reuse it if needed.
     */
    private applyGroupColors(): void {
        this.boidSystem.boids.forEach(b => {
            if (b.groupData && b.groupData.color) {
                b.color.set(b.groupData.color);
            }
        });
    }

    private updateScene0_split(): void {
        const numGroups = this.config.groups.length;
        this.boidSystem.boids.forEach(boid => {
            this.initialBoids.forEach(b => {
                b.isVisible = true;
                b.lightIntensity = 1.0;
            });
            if (boid.groupData) {
                const groupIndex = this.config.groups.indexOf(boid.groupData);
                const angle = (groupIndex / numGroups) * Math.PI * 2;

                const centerOfMass = boid.storyTarget!.clone(); // 从上一场景的位置开始
                const targetPos = new Vector3(
                    Math.cos(angle) * 300,
                    450,
                    Math.sin(angle) * 300
                );

                // 从花朵形态平滑过渡到分组形态
                const progress = this.sceneTime / 10;
                boid.storyTarget = centerOfMass.lerp(targetPos, progress);
                boid.color.set(boid.groupData.color);
            }
        });
    }

    // ============================================================================
    private updateScene1_conv(): void {
        // 场景1：无人机缓慢聚拢到中心位置

        const center = new Vector3(0, 100, 0);
        this.boidSystem.boids.forEach(b => {
            b.isVisible = true;
            const progress = this.sceneTime / this.config.scene1_duration;
            const centerOfMass = b.storyTarget!.clone(); // 从上一场景的位置开始
            b.storyTarget = centerOfMass.lerp(center, progress);
            b.lightIntensity = Math.min(b.lightIntensity + 0.01, 1.0); // 渐亮
        });
    }

    // ============================================================================
    private updateScene2_shape(): void {
        // 场景2：无人机形成一个特定形状（flower）
        const total = Math.max(1, this.config.totalBoidCount);
        const progress = Math.min(1, this.sceneTime / Math.max(0.0001, this.config.scene4_duration));
        const R = 100;

        // number of star lobes (5 is the common star). You can tune this via config in future.
        const lobes = 5;

        for (let i = 0; i < this.boidSystem.boids.length; i++) {
            const boid = this.boidSystem.boids[i];
            if (!boid) continue;

            // Angle around circle
            const angle = (i / total) * Math.PI * 2;

            // A simple star-like radial modulation using cosine creates sharp points.
            // r varies between ~0 and R depending on the lobes.
            const radialFactor = 0.5 + 0.5 * Math.cos(lobes * angle);
            const r = R * (0.3 + 0.7 * radialFactor); // keep minimum radius so center isn't empty

            const target = new Vector3(
                r * Math.sin(angle), // image at center
                r * Math.cos(angle) + 300, // elevate the star shape
                0
            );

            // Smoothly move storyTarget toward the star target as scene progresses.
            if (!boid.storyTarget) boid.storyTarget = new Vector3();
            // Use lerp with progress to provide a smooth arrival; add a tiny per-boid offset
            // so they don't perfectly overlap when r is identical.
            boid.storyTarget = boid.storyTarget.lerp(target, Math.min(1, progress));

            // keep color if group present, else default to white
            if (boid.groupData && boid.groupData.color) {
                boid.color.set(boid.groupData.color);
            }
        }
    }

    // ============================================================================
    private updateScene3_coolShape(): void {
        const progress = this.sceneTime / this.config.scene2_duration;
        const gba_coord: any[][] = [[561.4000244140625,330.8999938964844],[556.5579833984375,336.06048583984375],[555.5597534179688,344.0402526855469],[549.7189331054688,346.4603271484375],[544.4088745117188,340.5423889160156],[535.7554321289062,336.4580993652344],[529.3148498535156,330.7732849121094],[521.6295471191406,325.2394104003906],[512.0152893066406,324.04205322265625],[504.5875549316406,329.79010009765625],[498.0204772949219,335.951416015625],[493.5302734375,343.506591796875],[498.36956787109375,351.79302978515625],[503.8490905761719,359.2337341308594],[509.15875244140625,366.6503601074219],[513.0584106445312,372.16790771484375],[509.0130310058594,377.9237060546875],[515.4099731445312,379.2620849609375],[522.0807495117188,373.2981872558594],[530.9241943359375,371.9205017089844],[540.3399047851562,370.3106994628906],[550.1133422851562,371.1549072265625],[558.0538940429688,368.0918884277344],[566.2454833984375,363.4563903808594],[575.4740600585938,360.8564147949219],[584.6077270507812,358.5707702636719],[591.6210327148438,364.1605224609375],[593.9160766601562,372.2145080566406],[596.81005859375,381.40850830078125],[602.9803466796875,375.9852600097656],[611.906005859375,372.9697570800781],[607.4260864257812,366.41912841796875],[598.5689697265625,366.7291259765625],[598.944580078125,359.1944580078125],[607.7255859375,356.0055236816406],[608.630859375,351.5357666015625],[599.1464233398438,352.7801208496094],[590.5302124023438,349.9380187988281],[585.7882080078125,343.33966064453125],[586.52587890625,334.2423095703125],[577.8910522460938,332.6480712890625],[569.6317138671875,330.74176025390625],[413.3999938964844,366.70001220703125],[413.7409973144531,356.77313232421875],[415.984130859375,347.0046081542969],[422.8654479980469,339.8235778808594],[431.73358154296875,340.534423828125],[440.2722473144531,335.2858581542969],[438.6478271484375,325.8913269042969],[430.6890869140625,321.3017272949219],[429.1685485839844,312.0503845214844],[426.3675537109375,305.5025939941406],[424.8999938964844,296.34991455078125],[417.42852783203125,290.50213623046875],[417.8282470703125,282.16650390625],[417.4895935058594,273.30262756347656],[416.6141662597656,264.91416931152344],[410.38140869140625,257.1169738769531],[402.7119445800781,255.70314025878906],[399.58807373046875,263.5107727050781],[395.29998779296875,255.7167205810547],[393.4410095214844,246.0206298828125],[387.8853759765625,240.4104766845703],[385.02740478515625,231.1790008544922],[377.32086181640625,225.17889404296875],[376.5332336425781,216.11146545410156],[369.0644226074219,211.72335815429688],[366.1664733886719,219.853271484375],[363.1919250488281,227.80613708496094],[360.78094482421875,236.9257354736328],[363.82470703125,244.91775512695312],[368.14984130859375,253.11463928222656],[365.196533203125,261.9414978027344],[359.14044189453125,267.6999969482422],[358.652099609375,276.1168518066406],[361.7244873046875,285.4418640136719],[366.10406494140625,294.0096130371094],[358.45257568359375,299.6000061035156],[353.2720947265625,305.1473693847656],[346.4806823730469,312.51849365234375],[337.77154541015625,317.24761962890625],[330.54827880859375,323.8266906738281],[321.0994567871094,325.2145080566406],[314.4864196777344,332.7460021972656],[307.5,337.1757507324219],[307.5,347.19854736328125],[315.79656982421875,345.06951904296875],[324.87298583984375,345.6257629394531],[334.1578369140625,346.57708740234375],[342.5887756347656,341.1572265625],[350.3027038574219,346.6317138671875],[359.1520690917969,344.595703125],[363.69354248046875,336.1310729980469],[367.8802490234375,327.30987548828125],[376.8448791503906,322.8275451660156],[385.8952331542969,324.47711181640625],[394.98175048828125,328.70703125],[399.4630432128906,337.0799255371094],[401.79998779296875,346.7134094238281],[404.13238525390625,355.32867431640625],[413,360],[404.2349548339844,355.3827209472656],[401.79998779296875,346.9453125],[399.5758056640625,337.40899658203125],[395.4021911621094,328.9027404785156],[386.42083740234375,324.7217712402344],[377.46710205078125,322.5164489746094],[368.60614013671875,326.9468994140625],[364.02703857421875,335.26556396484375],[360.1038513183594,344.1679382324219],[351.1873779296875,347.3810729980469],[343.62799072265625,340.97784423828125],[335.3281555175781,345.82476806640625],[326.3106994628906,346.07818603515625],[317.79998779296875,344.3846435546875],[321.33489990234375,353.1131896972656],[318.90313720703125,361.2458801269531],[310.50555419921875,358.1728820800781],[302.39410400390625,361.4018249511719],[297.35137939453125,368.6000061035156],[290.7768249511719,374.06988525390625],[284.8999938964844,380.51348876953125],[282.6981201171875,389.8304748535156],[273.60443115234375,393.1536560058594],[268.877685546875,400.4875183105469],[260.34825134277344,401.75885009765625],[256.9793701171875,410.510009765625],[255.57223510742188,417.2425537109375],[256.9523468017578,426.5694274902344],[260.7147216796875,432.62646484375],[269.1390075683594,435.7790832519531],[277.0429992675781,440.2202453613281],[283.21331787109375,445.31072998046875],[286.7474670410156,453.77581787109375],[295.5779724121094,458.1740417480469],[301.6205139160156,465.45098876953125],[303.1424865722656,474.7972717285156],[299.62677001953125,483.63507080078125],[297.387939453125,492.417236328125],[305.3814697265625,489.2933044433594],[305.5911560058594,479.9800720214844],[304.8501892089844,470.13427734375],[305.18280029296875,460.6475830078125],[313.1798400878906,458.0147399902344],[314.6879577636719,460.3023986816406],[306.6364440917969,464.314208984375],[308.24700927734375,473.83026123046875],[316.0661926269531,478.2965393066406],[324.2969970703125,483.5561828613281],[332.8419494628906,484.9172058105469],[338.22222900390625,480.4328308105469],[338.6868896484375,471.3602600097656],[346.400390625,468.0284423828125],[353.90087890625,465.3961181640625],[356.5625305175781,457.9640197753906],[363.85382080078125,455.7328186035156],[370.22845458984375,461.4549560546875],[371.7892761230469,469.3699951171875],[378.77081298828125,469.9830017089844],[386.5276794433594,465.54296875],[390.2287292480469,459.01702880859375],[388.96942138671875,451.4351806640625],[386.68048095703125,442.24432373046875],[387.6000061035156,432.431640625],[394.28863525390625,434.7658386230469],[396.7680358886719,428.649169921875],[397.1404113769531,422.4677734375],[403.7684631347656,419.0641174316406],[411.975830078125,414.03515625],[414.78875732421875,404.586669921875],[414.82745361328125,394.814208984375],[411.8384094238281,386.9099426269531],[420.6490478515625,389.1705322265625],[423.3055419921875,381.4381408691406],[421.66998291015625,372.1546630859375],[458.3999938964844,346],[466.035400390625,351.60772705078125],[472.43426513671875,358.5919494628906],[478.7372131347656,363.5220642089844],[479.3772277832031,354.52618408203125],[473.6695251464844,346.8861389160156],[470.16741943359375,338.8318176269531],[471.4326477050781,330.477294921875],[466.5599060058594,323.6631164550781],[465.046630859375,314.1177062988281],[461.48046875,305.0609436035156],[460.6234436035156,295.63232421875],[466.52001953125,287.62359619140625],[475.2607421875,283.1734313964844],[485.033447265625,283.22381591796875],[494.42181396484375,280.6642761230469],[504.3580017089844,280.76202392578125],[512.1238098144531,275.9573059082031],[514.2229614257812,266.43934631347656],[511.04425048828125,258.3668670654297],[514.6321105957031,249.6906280517578],[522.94140625,249.60604858398438],[528.8000183105469,243.5668487548828],[531.1965637207031,234.84263610839844],[527.1011047363281,227.1946563720703],[517.8817138671875,224.3780517578125],[511.5148620605469,216.73785400390625],[508.9984130859375,207.3227081298828],[508.6566162109375,198.80516052246094],[515.2363586425781,191.3915252685547],[523.4382019042969,186.13072204589844],[531.6498413085938,181.46560668945312],[534.7093505859375,172.13360595703125],[535.2116088867188,162.40269470214844],[529.423095703125,157.27613830566406],[519.74267578125,158.5384979248047],[510.3655700683594,159.98092651367188],[500.8122863769531,161.1876983642578],[493.7799072265625,168.22010803222656],[488.03802490234375,175.74366760253906],[479.07696533203125,178.81114196777344],[478.5044250488281,187.98301696777344],[475.17840576171875,196.39999389648438],[467.71234130859375,195.12867736816406],[457.91949462890625,195.68370056152344],[449.5589294433594,190.29757690429688],[440.6683654785156,190.0048370361328],[438.201904296875,199.6394500732422],[431.2293701171875,204.61769104003906],[424.3592834472656,211.23031616210938],[418.8899841308594,218.5572509765625],[412.3113708496094,222.8000030517578],[402.7193298339844,224.2697296142578],[393.6380920410156,228.05943298339844],[385.8343811035156,232.13748168945312],[387.7580871582031,241.6621856689453],[393.8526611328125,246.9968719482422],[395.29998779296875,256.81988525390625],[400.0433654785156,263.2794952392578],[403.5846862792969,255.33253479003906],[410.8739929199219,257.8349609375],[417.175048828125,265.4750671386719],[417.22918701171875,273.96929931640625],[417.5165710449219,282.7235412597656],[417.9060974121094,290.7960510253906],[424.8999938964844,296.83319091796875],[426.7236328125,305.6972961425781],[429.009521484375,312.337646484375],[430.8212585449219,321.5149230957031],[438.68988037109375,326.05950927734375],[441.6032409667969,335.3460693359375],[450.0016174316406,340.67303466796875],[507.6000061035156,280.8999938964844],[513.2758483886719,273.06915283203125],[514.2099914550781,263.3635711669922],[513.1927185058594,255.92205810546875],[516.6239929199219,247.41250610351562],[525.7893676757812,248.42637634277344],[529.8380737304688,240.71298217773438],[530.5264587402344,231.64442443847656],[523.8903503417969,226.57034301757812],[515.78564453125,221.86280822753906],[510.826904296875,213.55552673339844],[506.6432189941406,205.03887939453125],[510.73052978515625,196.2978515625],[517.4597778320312,188.97044372558594],[526.4522094726562,184.8107147216797],[532.0811157226562,178.20033264160156],[535.5381469726562,169.04310607910156],[535.0494995117188,159.10655212402344],[543.689697265625,158.35794067382812],[552.7032470703125,154.48231506347656],[562.206298828125,156.2357940673828],[569.9092407226562,159.90673828125],[576.8011474609375,166.28286743164062],[574.112060546875,175.2616729736328],[576.4979248046875,184.78555297851562],[584.7525634765625,190.30242919921875],[592.9442138671875,195.35986328125],[602.047607421875,196.67140197753906],[605.3575439453125,205.57589721679688],[609.2373046875,214.296630859375],[617.7847290039062,217.94290161132812],[625.1658935546875,223.22970581054688],[620.006591796875,230.77557373046875],[617.0889282226562,237.9084930419922],[625.035400390625,240.3896942138672],[631.9660034179688,247.39952087402344],[636.5999755859375,255.38528442382812],[637.296630859375,264.7932434082031],[643.2791748046875,272.50677490234375],[650.166259765625,269.81915283203125],[653.5025024414062,260.6117706298828],[656.0183715820312,251.42764282226562],[662.0662231445312,250.14202880859375],[668.81787109375,251.00115966796875],[677.9905395507812,248.7180938720703],[686.031982421875,243.46868896484375],[695.4157104492188,241.67828369140625],[705.2298583984375,241.15310668945312],[710.3538208007812,249.00746154785156],[718.8992919921875,253.1708221435547],[723.9805908203125,261.5275115966797],[720.1484375,268.7443389892578],[712.7871704101562,274.5851287841797],[707.1299438476562,280.50469970703125],[704.0866088867188,288.777099609375],[695.2341918945312,293.2409973144531],[688.4756469726562,300.0654602050781],[679.1388549804688,299.0572509765625],[671.6437377929688,305.3407897949219],[662.3816528320312,308.7776794433594],[657.0799560546875,315.0276184082031],[657.3917236328125,323.74114990234375],[662.1660766601562,331.9941711425781],[668.3842163085938,338.6683654785156],[666.181640625,346.3492126464844],[660.7640991210938,339.46929931640625],[653.413818359375,334.2138671875],[649.6196899414062,337.22607421875],[654.4892578125,342.36663818359375],[662.0855712890625,347.5623474121094],[655.7881469726562,353.56414794921875],[654.8141479492188,363.34808349609375],[651.1158447265625,362.0570068359375],[644.2862548828125,359.2784423828125],[635.0496215820312,360.42901611328125],[629.8780517578125,355.15362548828125],[632.0022583007812,346.1483154296875],[632.176025390625,337.8838195800781],[638.5845336914062,331.6631774902344],[641.0276489257812,325.6730651855469],[633.4298706054688,326.7785949707031],[628.5884399414062,331.986083984375],[619.3565673828125,333.6842956542969],[609.949951171875,336.27679443359375],[605.5256958007812,342.3143005371094],[600.1380004882812,347.4324035644531],[593.5988159179688,351.9498596191406],[589.369140625,344.71533203125],[586.7327880859375,337.9945373535156],[580.776123046875,334.09088134765625],[573.2112426757812,329.79998779296875],[564.2726440429688,333.16326904296875],[561.0390625,324.6189270019531],[562.9043579101562,314.9461669921875],[558.9025268554688,306.96966552734375],[553.9996337890625,301.52099609375],[548.3045043945312,297.5251770019531],[545.0225830078125,290.1831359863281],[536.1309814453125,286.0538330078125],[526.4056701660156,285.6286315917969],[517.1585083007812,282.7615966796875],[413.3999938964844,366.70001220703125],[413.7739562988281,356.6295166015625],[416.05010986328125,346.7173156738281],[423.1801452636719,339.5130310058594],[432.23577880859375,340.2257080078125],[440.8999938964844,334.8999938964844],[449.1615905761719,340.14019775390625],[457.42315673828125,345.3804016113281],[463.4140930175781,353.01971435546875],[468.7164611816406,361.1629638671875],[471.2851867675781,370.6030578613281],[469.872314453125,379.6268310546875],[464.2347717285156,386.97943115234375],[457.4738464355469,391.72772216796875],[456.0044250488281,400.71307373046875],[458.5294494628906,409.3470458984375],[454.6231994628906,416.194580078125],[446.4685363769531,419.10498046875],[437.74951171875,414.92181396484375],[433.2099914550781,406.25543212890625],[428.67047119140625,397.58905029296875],[424.13092041015625,388.92266845703125],[423.1766357421875,379.2608337402344],[419.9523010253906,371.021728515625],[413.28472900390625,364.7693176269531],[414.1202697753906,355.1214294433594],[416.7673034667969,345.84149169921875],[423.7400207519531,339.0165100097656],[432.5653381347656,340.0231628417969],[364.8999938964844,216.1999969482422],[361.1365661621094,206.96705627441406],[357.3428649902344,197.757568359375],[349.88812255859375,191.381591796875],[346.02630615234375,182.1893768310547],[343.3825378417969,172.76947021484375],[346.0650329589844,163.3987274169922],[342.80694580078125,155.89999389648438],[333.11865234375,155.26144409179688],[326.4062805175781,147.88886260986328],[321.5,139.81727600097656],[318.42987060546875,130.50847625732422],[311.2845458984375,125.53751373291016],[311.9476013183594,115.81497955322266],[314.3999938964844,106.4020004272461],[307.36737060546875,100.65311431884766],[300.13232421875,94.34166717529297],[292.6519775390625,88.76512145996094],[285.13916015625,89.17333221435547],[285.0840759277344,98.63196563720703],[286.3439025878906,107.30731964111328],[279.5805358886719,114.61946868896484],[272.6374206542969,120.03641510009766],[266.5681915283203,112.12596893310547],[258.27113342285156,111.1727066040039],[249.93792724609375,116.55896759033203],[240.5076904296875,116.00601959228516],[231.64183044433594,115.55856323242188],[227.85275268554688,124.78101348876953],[230.50994873046875,133.63228607177734],[235.33511352539062,142.35738372802734],[237.53485107421875,150.13400268554688],[229.01544189453125,155.31381225585938],[222.74267578125,162.8359832763672],[221.5,172.43023681640625],[213.63929748535156,176.20118713378906],[203.807373046875,174.5447235107422],[195.56980895996094,176.98167419433594],[194.67544555664062,186.02073669433594],[194.08241271972656,195.41758728027344],[186.59848022460938,201.70318603515625],[176.92967224121094,204.1372833251953],[173.89999389648438,211.74627685546875],[173.89999389648438,221.71676635742188],[165.29551696777344,226.56410217285156],[161.80181884765625,235.15696716308594],[159.96437072753906,244.95668029785156],[166.26214599609375,251.29359436035156],[175.33218383789062,255.4342498779297],[184.5186767578125,255.0988006591797],[190.7078399658203,260.0915222167969],[195.7699432373047,268.61329650878906],[204.06588745117188,274.1439208984375],[213.48211669921875,276.9634094238281],[223.26231384277344,278.9022216796875],[233.1250457763672,280],[243.09556579589844,280],[251.22315979003906,285.29998779296875],[261.1936798095703,285.29998779296875],[269.9095458984375,289.5614318847656],[278.5428161621094,285.8540954589844],[284.2786560058594,278.1309814453125],[293.3051452636719,274.5340576171875],[299.1400146484375,280.1800842285156],[296.7431640625,288.26580810546875],[290.437255859375,295.9330749511719],[288.5912170410156,305.73114013671875],[291.4713134765625,314.51348876953125],[293.8397216796875,324.0829772949219],[300.3141174316406,331.3431091308594],[309.5453796386719,334.12237548828125],[317.5897521972656,329.211669921875],[325.69744873046875,324.9941711425781],[333.3997802734375,320.2186584472656],[341.90521240234375,315.3546142578125],[349.5259094238281,309.21331787109375],[353.9618225097656,300.82061767578125],[362.1888122558594,298.0598449707031],[364.5967102050781,290.34857177734375],[359.559814453125,281.7438659667969],[358.1271057128906,271.9168701171875],[363.11431884765625,267.40025329589844],[366.66778564453125,258.0845184326172],[367.1907958984375,249.1533660888672],[360.5125732421875,242.91912841796875],[360.9585876464844,232.95858764648438],[366.02862548828125,225.10240173339844],[473.5,340.79998779296875],[480.2705078125,347.95135498046875],[485.09344482421875,352.0479736328125],[482.66412353515625,342.7513122558594],[402.20001220703125,438.3999938964844],[407.62347412109375,446.2965087890625],[411.2487487792969,453.9438781738281],[419.4441223144531,458.8375549316406],[421.0969543457031,466.0140686035156],[426.9364013671875,463.3304748535156],[422.92279052734375,457.5489807128906],[419.62860107421875,450.2857666015625],[423.1474914550781,444.8245849609375],[425.9666748046875,440.00006103515625],[431.1538391113281,441.6822509765625],[432.9928283691406,449.8761901855469],[441.8172607421875,450.7839050292969],[444.3017578125,443.4461669921875],[444.8416442871094,433.9249572753906],[446.6422424316406,426.0317687988281],[452.7318115234375,429.6255798339844],[459.3005065917969,436.892578125],[466.3946838378906,435.1645812988281],[463.3138732910156,426.1990051269531],[463.2024841308594,416.8994445800781],[470.3589172363281,414.5146179199219],[467.12860107421875,405.7064514160156],[471.8583068847656,399.0726013183594],[475.02655029296875,393.9428405761719],[477.0411376953125,386.19085693359375],[468.9793701171875,389.87530517578125],[461.68621826171875,387.8563537597656],[457.8153991699219,394.6307067871094],[455.657470703125,403.36859130859375],[459.7297668457031,412.3288879394531],[451.747802734375,418.3713073730469],[442.955810546875,417.5681457519531],[435.8647155761719,411.3235778808594],[431.219482421875,402.45538330078125],[426.57427978515625,393.58721923828125],[420.09857177734375,389.3636779785156],[411.50244140625,387.5099182128906],[415.0603332519531,395.5711364746094],[414.7051086425781,405.47900390625],[411.6428527832031,414.9786376953125],[403.3282165527344,419.9853210449219],[405.4098815917969,429.28857421875],[493,341.1000061035156],[484.04620361328125,337.79998779296875],[480.281005859375,332],[473.1823425292969,327.0477294921875],[469.20001220703125,318.80633544921875],[472.6922607421875,309.8697204589844],[465.9895935058594,307.864013671875],[463.755615234375,298.7455749511719],[463.8133239746094,291.2998046875],[471.1089782714844,284.9898376464844],[480.5524597167969,282.82989501953125],[490.0839538574219,281.36297607421875],[499.9306335449219,280.5736389160156],[509.8103332519531,281.544677734375],[519.4778442382812,282.5130920410156],[528.556884765625,286.474609375],[538.3197631835938,286.73187255859375],[547.2460327148438,291.1466064453125],[547.8241577148438,299.7713928222656],[556.4510498046875,301.1219177246094],[558.6937255859375,309.4747619628906],[562.226806640625,317.3983154296875],[561.186767578125,327.18890380859375],[555.7236938476562,332.7667236328125],[557.6847534179688,341.3778076171875],[551.7119140625,348.1000061035156],[547.64453125,340.9532775878906],[538.637451171875,337.4622497558594],[530.50439453125,333.56414794921875],[523.5281066894531,327.39190673828125],[514.8119812011719,324.2703552246094],[507.0205078125,328.6376647949219],[500.37872314453125,334.9093933105469],[338.6000061035156,493.5],[330.7547302246094,496.8999938964844],[322.7516174316406,501.8592834472656],[320.9845275878906,510.2690124511719],[330.7960510253906,509.5414123535156],[337.7566833496094,502.3985595703125],[362.5,484.1000061035156],[356.06396484375,489.4284973144531],[351.07574462890625,491.3660583496094],[345.9343566894531,496.8656311035156],[353.5526123046875,496.9007263183594],[352.9564208984375,502.5790710449219],[351.0850830078125,508.20001220703125],[355.2702941894531,514.5089721679688],[358.9402770996094,509.667724609375],[359.478759765625,501.8324890136719],[359.74359130859375,493.6088562011719],[367.1009521484375,487.4980773925781],[311.6000061035156,497.3999938964844],[368.6000061035156,508.70001220703125],[392.8999938964844,467.20001220703125],[391.7243957519531,471.79998779296875],[407.29998779296875,459.1000061035156],[406.5,469.5],[413.1094665527344,471.07562255859375],[465.29998779296875,422.6000061035156],[470.5791931152344,416.31005859375],[466.20001220703125,426.1000061035156],[472,430.04571533203125],[542.7000122070312,407.70001220703125],[541.5661010742188,414.3993225097656],[544.7510986328125,422.3829650878906],[548.1555786132812,414.7899169921875],[555.4830322265625,416.9825134277344],[562.8219604492188,423.49688720703125],[565.1868896484375,416.6127624511719],[560.1227416992188,408.3849792480469],[550.8368530273438,408.194091796875],[533.2000122070312,397.70001220703125],[530.0902099609375,405.7782287597656],[530.2652893066406,415.95281982421875],[521.56494140625,420],[513.0910339355469,417.9573669433594],[504.2978210449219,418.8704528808594],[503.43408203125,411.78167724609375],[511.103271484375,406.62371826171875],[516.4739685058594,400.276123046875],[524.6849670410156,402.93927001953125],[531.8999938964844,372.29998779296875],[526.2603454589844,376.8999938964844],[518.9535522460938,382.2090759277344],[513.2999877929688,387.7406005859375],[518.70068359375,394.29998779296875],[526.4008483886719,393.03033447265625],[534.8441772460938,395.2020568847656],[542.2413330078125,398.5],[550.0494384765625,402.7494201660156],[557.7406005859375,402.44476318359375],[566.3693237304688,403.46051025390625],[572.6834716796875,404.1468505859375],[565.1621704101562,398.62457275390625],[565.2009887695312,391.4095153808594],[572.5012817382812,394.41375732421875],[580.9908447265625,394.9933166503906],[580.1265258789062,386.4572448730469],[575.807861328125,380.22027587890625],[566.7015991210938,381.67230224609375],[559.1329956054688,385.46466064453125],[551.62646484375,382.5272216796875],[557.758056640625,377.9956970214844],[566.6090087890625,375.6833801269531],[572.4714965820312,372.4134216308594],[566.1807861328125,366.8614501953125],[557.9470825195312,368.53717041015625],[550.1563110351562,371.1630859375],[540.8850708007812,370.29803466796875]];

        this.boidSystem.boids.forEach((boid, i) => {
            // use 617 boids only
            if (i >= 617){
                boid.storyTarget!.set(0, -1000, 0);
                boid.lightIntensity = 0;
            }
            else {
                const targetX = (gba_coord[i][0] - 400); // center the shape and scale
                const targetY = (300 - gba_coord[i][1]) + 300; // flip the y axis and scale
                const targetZ = 0;
                boid.storyTarget = new Vector3();
                // go to position
                boid.storyTarget!.set(targetX, targetY, targetZ);

                // light pulse 
                const progress = this.sceneTime / this.config.scene3_duration;
                boid.lightIntensity = Math.sin(progress * Math.PI * this.config.scene3_duration/2 + 3* Math.PI/2 * i/this.boidSystem.boids.length) * 0.5 + 0.5; 
            }
      });
    }

    // ============================================================================
    private updateScene4_circle(): void {
        const center = new Vector3(0, 300, 0);
        const radius = 150;
        const angleStep = (2 * Math.PI) / this.boidSystem.boids.length;

        this.boidSystem.boids.forEach((boid, index) => {
            // circle no spin
            const angle = index * angleStep;
            const targetX = center.x + radius * Math.cos(angle);
            const targetY = center.y + radius * Math.sin(angle);
            const targetZ = 0;
            boid.storyTarget!.set(targetX, targetY, targetZ);

            const progress = this.sceneTime / this.config.scene4_duration;

            boid.lightIntensity = Math.sin(progress * Math.PI * this.config.scene4_duration/2) * 0.5 + 0.5; 
        });
    }
}
